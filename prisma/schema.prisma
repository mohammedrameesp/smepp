// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════════════════════════════
// LEGACY ROLE ENUM (For approval workflows - will be deprecated)
// ═══════════════════════════════════════════════════════════════════════════════
enum Role {
  EMPLOYEE
  MANAGER // First-level approver
  HR_MANAGER // HR approvals
  FINANCE_MANAGER // Finance/budget approvals
  OPERATIONS_MANAGER // Operations/asset approvals
  DIRECTOR // High-value approvals
  ADMIN // Legacy - kept for backwards compatibility
}

// ═══════════════════════════════════════════════════════════════════════════════
// TEAM MEMBER ENUMS
// ═══════════════════════════════════════════════════════════════════════════════
// Note: TeamMemberRole enum was removed - replaced by boolean flags:
// isAdmin, hasOperationsAccess, hasHRAccess, hasFinanceAccess, canApprove

enum TeamMemberStatus {
  ACTIVE
  INACTIVE
  OFFBOARDED
  TERMINATED
}

enum OffboardingReason {
  RESIGNATION
  RETIREMENT
  CONTRACT_END
  OTHER
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  PROBATION
  INTERN
}

enum WorkLocation {
  OFFICE
  REMOTE
  HYBRID
}

enum Gender {
  MALE
  FEMALE
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum BillingCycle {
  MONTHLY
  YEARLY
  ONE_TIME
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
}

enum AssetStatus {
  IN_USE
  SPARE
  REPAIR
  DISPOSED
}

enum DisposalMethod {
  SOLD // Asset sold to third party
  SCRAPPED // Asset physically destroyed/discarded
  DONATED // Asset given to charity/organization
  WRITTEN_OFF // Asset written off (theft, loss, obsolete)
  TRADED_IN // Asset traded in for new purchase
}

enum SupplierStatus {
  PENDING
  APPROVED
  REJECTED
}

// Leave Management Enums
enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaveRequestType {
  FULL_DAY
  HALF_DAY_AM
  HALF_DAY_PM
}

enum LeaveCategory {
  STANDARD // Auto-initialized for all employees (Annual, Unpaid, Compassionate)
  MEDICAL // Medical-related, balance created on request (Sick Leave)
  PARENTAL // Gender-specific, balance created on request (Maternity, Paternity)
  RELIGIOUS // Religious leave, balance created on request (Hajj)
}

// ═══════════════════════════════════════════════════════════════════════════════
// NOTIFICATION SYSTEM ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum NotificationType {
  LEAVE_REQUEST_SUBMITTED
  LEAVE_REQUEST_APPROVED
  LEAVE_REQUEST_REJECTED
  LEAVE_REQUEST_CANCELLED
  ASSET_ASSIGNED
  ASSET_UNASSIGNED
  ASSET_REQUEST_SUBMITTED
  ASSET_REQUEST_APPROVED
  ASSET_REQUEST_REJECTED
  ASSET_RETURN_SUBMITTED
  ASSET_ASSIGNMENT_PENDING
  ASSET_ASSIGNMENT_ACCEPTED
  ASSET_ASSIGNMENT_DECLINED
  PURCHASE_REQUEST_SUBMITTED
  PURCHASE_REQUEST_APPROVED
  PURCHASE_REQUEST_REJECTED
  DOCUMENT_EXPIRY_WARNING
  GENERAL
  // Multi-level approval notifications
  APPROVAL_PENDING // Notify approver they have a pending approval
  APPROVAL_STEP_COMPLETED // Notify next approver/requester of step completion
  APPROVAL_FINAL_APPROVED // Notify requester of final approval
  APPROVAL_REJECTED // Notify requester of rejection at any level
  // Supplier notifications
  SUPPLIER_APPROVED // Notify admins when supplier is approved
  SUPPLIER_REJECTED // Notify admins when supplier is rejected
  // Payroll notifications
  PAYROLL_SUBMITTED // Notify admins when payroll is submitted for approval
  PAYROLL_APPROVED // Notify admins when payroll is approved
  // Team member notifications
  TEAM_MEMBER_JOINED // Notify HR/admins when new member joins via SSO
}

// ═══════════════════════════════════════════════════════════════════════════════
// ASSET REQUEST WORKFLOW ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum AssetRequestType {
  EMPLOYEE_REQUEST // Employee requests a spare asset
  ADMIN_ASSIGNMENT // Admin assigns asset to user
  RETURN_REQUEST // User requests to return assigned asset
}

enum AssetRequestStatus {
  PENDING_ADMIN_APPROVAL // Employee request waiting for admin
  PENDING_USER_ACCEPTANCE // Admin assignment waiting for user
  PENDING_RETURN_APPROVAL // Return request waiting for admin
  ACCEPTED // User accepted assignment
  APPROVED // Admin approved request/return
  REJECTED // Admin rejected
  REJECTED_BY_USER // User declined assignment
  EXPIRED // Request timed out
  CANCELLED // Cancelled by requester
}

// ═══════════════════════════════════════════════════════════════════════════════
// MULTI-LEVEL APPROVAL WORKFLOW ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum ApprovalModule {
  LEAVE_REQUEST
  PURCHASE_REQUEST
  ASSET_REQUEST
}

enum ApprovalStepStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}

// ═══════════════════════════════════════════════════════════════════════════════
// MULTI-TENANT SAAS ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum SubscriptionTier {
  FREE
  PLUS
}

enum WhatsAppSource {
  NONE // WhatsApp disabled
  PLATFORM // Use platform-wide config
  CUSTOM // Use tenant's own config
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String    @unique
  emailVerified   DateTime?
  image           String?
  passwordHash    String? // For email/password auth
  role            Role      @default(EMPLOYEE)
  isSystemAccount Boolean   @default(false) // For shared assets and system users
  isSuperAdmin    Boolean   @default(false) // Platform-level admin (can manage all orgs)
  // NOTE: isEmployee, canLogin, isOnWps moved to TeamMember model

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Session security - used to invalidate sessions on password change
  passwordChangedAt DateTime? // Set when password is changed, checked against session iat

  // Account lockout (brute-force protection)
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime? // Account locked until this time

  // Initial password setup (for new employees)
  setupToken       String?   @unique
  setupTokenExpiry DateTime?

  // Soft-delete fields
  isDeleted           Boolean   @default(false)
  deletedAt           DateTime?
  scheduledDeletionAt DateTime? // 7 days after deletedAt for permanent deletion
  deletedByUserId     String?

  // Two-Factor Authentication (for super admins)
  twoFactorSecret      String? // Encrypted TOTP secret
  twoFactorEnabled     Boolean   @default(false)
  twoFactorBackupCodes String[] // Hashed backup codes
  pending2FATokenJti   String? // Current pending 2FA token's unique ID (prevents replay)
  twoFactorVerifiedAt  DateTime? // Last 2FA verification timestamp (for sensitive ops re-verification)

  // NextAuth relations (keep for authentication)
  accounts Account[]
  sessions Session[]

  // NOTE: hrProfile and organizationMemberships removed
  // Use TeamMember model for all organization and HR data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Index for scheduled deletion cron job
  @@index([scheduledDeletionAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ═══════════════════════════════════════════════════════════════════════════════
// MULTI-TENANT ORGANIZATION MODELS
// ═══════════════════════════════════════════════════════════════════════════════

model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique // URL-friendly identifier (e.g., "acme-corp")

  // Branding
  logoUrl            String?
  logoUrlInverse     String? // Auto-generated white version for dark backgrounds
  primaryColor       String  @default("#0f172a") // Slate - brand primary
  secondaryColor     String? // Accent color
  loginBackgroundUrl String? // Background image for login page
  welcomeTitle       String? // Custom welcome title (e.g., "Welcome to Acme")
  welcomeSubtitle    String? // Custom welcome subtitle/tagline
  website            String? // Organization's public website URL

  // Settings
  timezone    String @default("Asia/Qatar") // Hardcoded to Qatar timezone (UTC+3)
  currency    String @default("QAR") // Primary currency always QAR
  weekendDays Int[]  @default([5, 6]) // Weekend days: 0=Sun, 1=Mon, ..., 5=Fri, 6=Sat (default: Fri-Sat)

  // Reference Code Prefix (auto-generated from org name, customizable by admin)
  // Used for employee IDs, asset tags, purchase requests, etc.
  codePrefix String @default("ORG")

  // Custom code format patterns for different entity types
  // JSON structure: { "employees": "{PREFIX}-{YYYY}-{SEQ:3}", "assets": "{PREFIX}-{TYPE}-{YYMM}-{SEQ:3}", ... }
  codeFormats Json @default("{}")

  // Organization metadata (for super-admin tracking)
  industry      String? // Technology, Retail, Healthcare, etc.
  companySize   String? // 1-10, 11-50, 51-200, 201-500, 500+
  internalNotes String? // Super-admin only notes (not visible to org users)

  // Module configuration (client chooses which to enable)
  enabledModules String[] @default(["assets", "subscriptions", "suppliers"])

  // AI Chat feature (super-admin controlled)
  aiChatEnabled        Boolean @default(false)
  aiTokenBudgetMonthly Int? // Custom monthly AI token limit (null = use tier default)
  chatRetentionDays    Int? // Chat conversation retention (null = 90 days, 0 = never delete)

  // Additional currencies beyond QAR (e.g., ["USD", "EUR"])
  additionalCurrencies String[] @default([])

  // Location tracking (for multi-location organizations)
  hasMultipleLocations Boolean @default(false)

  // Onboarding tracking
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?
  onboardingStep        Int       @default(0) // Current step in wizard (0-5)

  // Subscription & Billing
  subscriptionTier SubscriptionTier @default(FREE)
  stripeCustomerId String?          @unique
  stripePriceId    String? // Current subscription price
  stripeSubEnd     DateTime? // Subscription end date

  // Usage Limits (no longer enforced - kept for backwards compatibility)
  maxUsers  Int @default(9999)
  maxAssets Int @default(9999)

  // ═══════════════════════════════════════════════════════════════════════════════
  // AUTHENTICATION CONFIGURATION (Super Admin only)
  // ═══════════════════════════════════════════════════════════════════════════════

  // Allowed auth methods: ["credentials", "google", "azure-ad"]
  // Empty array = all platform-enabled methods allowed (default)
  allowedAuthMethods String[] @default([])

  // Email domain restrictions (e.g., ["company.com", "subsidiary.com"])
  // Empty array = any email domain allowed (default)
  allowedEmailDomains String[] @default([])

  // Whether to enforce domain restriction (block logins from other domains)
  enforceDomainRestriction Boolean @default(false)

  // Custom OAuth credentials (Enterprise feature - encrypted)
  // These override platform-level OAuth apps when provided
  customGoogleClientId     String?
  customGoogleClientSecret String? // Encrypted at rest
  customAzureClientId      String?
  customAzureClientSecret  String? // Encrypted at rest
  customAzureTenantId      String? // For Azure AD directory restriction

  // Custom Email Configuration (Enterprise feature - for white-label emails)
  // When configured, emails are sent from organization's own domain
  customSmtpHost     String? // e.g., "smtp.gmail.com", "smtp.office365.com"
  customSmtpPort     Int? // e.g., 587, 465
  customSmtpUser     String? // SMTP username/email
  customSmtpPassword String? // Encrypted at rest
  customSmtpSecure   Boolean @default(true) // Use TLS/SSL
  customEmailFrom    String? // e.g., "notifications@company.com"
  customEmailName    String? // e.g., "Company Notifications"

  // Core Relations
  teamMembers   TeamMember[] // Unified model for all organization members
  invitations   OrganizationInvitation[]
  setupProgress OrganizationSetupProgress?

  // Tenant-scoped data relations
  assets                 Asset[]
  assetCategories        AssetCategory[]
  assetTypeMappings      AssetTypeMapping[]
  locations              Location[]
  assetHistories         AssetHistory[]
  subscriptions          Subscription[]
  activityLogs           ActivityLog[]
  notifications          Notification[]
  approvalPolicies       ApprovalPolicy[]
  approvalSteps          ApprovalStep[]
  maintenanceRecords     MaintenanceRecord[]
  suppliers              Supplier[]
  supplierEngagements    SupplierEngagement[]
  systemSettings         SystemSettings[]
  profileChangeRequests  ProfileChangeRequest[]
  purchaseRequests       PurchaseRequest[]
  leaveTypes             LeaveType[]
  leaveBalances          LeaveBalance[]
  leaveRequests          LeaveRequest[]
  publicHolidays         PublicHoliday[]
  salaryStructures       SalaryStructure[]
  payrollRuns            PayrollRun[]
  payslips               Payslip[]
  employeeLoans          EmployeeLoan[]
  assetRequests          AssetRequest[]
  companyDocumentTypes   CompanyDocumentType[]
  companyDocuments       CompanyDocument[]
  depreciationCategories DepreciationCategory[]
  depreciationRecords    DepreciationRecord[]
  chatConversations      ChatConversation[]
  aiChatUsage            AIChatUsage[]
  aiChatAuditLogs        AIChatAuditLog[]
  emailFailureLogs       EmailFailureLog[]
  errorLogs              ErrorLog[]

  // Access Control
  rolePermissions RolePermission[]

  // WhatsApp integration
  whatsAppSource          WhatsAppSource        @default(NONE) // NONE, PLATFORM, or CUSTOM
  whatsAppPlatformEnabled Boolean               @default(false) // Super-admin controlled: can tenant use platform WhatsApp?
  whatsAppConfig          WhatsAppConfig?
  whatsAppUserPhones      WhatsAppUserPhone[]
  whatsAppActionTokens    WhatsAppActionToken[]
  whatsAppMessageLogs     WhatsAppMessageLog[]

  // Custom Domain Support (Super Admin only)
  customDomain                   String?   @unique // e.g., "app.company.com"
  customDomainVerified           Boolean   @default(false)
  customDomainVerifiedAt         DateTime?
  customDomainTxtValue           String? // DNS TXT verification value
  customDomainBypassVerification Boolean   @default(false) // Super admin override

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([stripeCustomerId])
  @@index([customDomain])
}

// OrganizationUser model REMOVED - Use TeamMember instead
// Removed in schema optimization for production

model OrganizationInvitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  email String
  name  String? // Optional name for the invitee (pre-filled in signup)
  role  String  @default("MEMBER") // Legacy: kept for backwards compatibility
  token String  @unique @default(cuid())

  // Employee classification - null means user will confirm during signup
  isEmployee Boolean? // true = employee (requires HR profile), false = system/service account
  isOnWps    Boolean? // true = on Wage Protection System (only relevant if isEmployee = true)

  invitedById String? // User who sent the invitation

  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  @@unique([organizationId, email])
  @@index([token])
  @@index([email])
}

// Custom role permissions per organization
// OWNER and ADMIN (isOwner/isAdmin flags) have all permissions by default (not stored)
// Non-admin users get custom permissions stored here with role='MEMBER'
model RolePermission {
  id         String       @id @default(cuid())
  tenantId   String
  tenant     Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role       String // 'MEMBER' for non-admin users (OWNER/ADMIN have all by default)
  permission String // e.g., "assets:view", "payroll:run"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, role, permission])
  @@index([tenantId])
  @@index([tenantId, role])
}

model OrganizationSetupProgress {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Checklist items
  profileComplete        Boolean @default(false) // Org name and basic info configured
  logoUploaded           Boolean @default(false) // Logo has been uploaded
  brandingConfigured     Boolean @default(false) // Primary color customized
  firstAssetAdded        Boolean @default(false) // At least one asset created
  firstTeamMemberInvited Boolean @default(false) // At least one invitation sent
  firstEmployeeAdded     Boolean @default(false) // At least one HR profile created

  // Allow users to dismiss the checklist
  isDismissed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

// ═══════════════════════════════════════════════════════════════════════════════
// TEAM MEMBER - Unified model replacing User + OrganizationUser + HRProfile
// ═══════════════════════════════════════════════════════════════════════════════
model TeamMember {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // ═══════════════════════════════════════════════════════════════════════════════
  // AUTHENTICATION
  // ═══════════════════════════════════════════════════════════════════════════════
  email         String
  name          String?
  passwordHash  String?
  emailVerified DateTime?
  image         String?
  canLogin      Boolean   @default(true)

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Session security
  passwordChangedAt DateTime?

  // Account lockout (brute-force protection)
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Initial password setup
  setupToken       String?   @unique
  setupTokenExpiry DateTime?

  // ═══════════════════════════════════════════════════════════════════════════════
  // OWNERSHIP
  // ═══════════════════════════════════════════════════════════════════════════════
  isOwner Boolean @default(false) // Org creator, cannot be removed

  // ═══════════════════════════════════════════════════════════════════════════════
  // ACCESS & PERMISSIONS (Boolean flags - replaces old enum-based roles)
  // ═══════════════════════════════════════════════════════════════════════════════
  isAdmin              Boolean   @default(false) // Full access, supersedes all other flags
  hasOperationsAccess  Boolean   @default(false) // Assets, Subscriptions, Suppliers
  hasHRAccess          Boolean   @default(false) // Employees, Leave modules
  hasFinanceAccess     Boolean   @default(false) // Payroll, Purchase Requests
  canApprove           Boolean   @default(false) // Approve direct reports (via reportingToId)
  permissionsUpdatedAt DateTime? // Tracks when permissions were last changed (for session refresh)

  // ═══════════════════════════════════════════════════════════════════════════════
  // EMPLOYEE FLAGS
  // ═══════════════════════════════════════════════════════════════════════════════
  isEmployee Boolean @default(true) // Has HR features (leave, payroll)?
  isOnWps    Boolean @default(true) // Included in WPS file?

  // Account type confirmation (for owners using service/shared accounts)
  accountTypeConfirmed   Boolean   @default(false)
  accountTypeConfirmedAt DateTime?

  // ═══════════════════════════════════════════════════════════════════════════════
  // EMPLOYEE CODE & BASIC INFO
  // ═══════════════════════════════════════════════════════════════════════════════
  employeeCode   String?
  dateOfJoining  DateTime?
  dateOfLeaving  DateTime?

  // Offboarding (voluntary exit)
  offboardingReason    OffboardingReason?
  offboardingNotes     String?
  offboardedAt         DateTime?
  offboardedByMemberId String?

  designation      String?
  department       String?
  employmentType   EmploymentType?
  workLocation     WorkLocation?
  probationEndDate DateTime?
  noticePeriodDays Int?            @default(30)
  reportingToId    String?         // TeamMember ID of manager

  // ═══════════════════════════════════════════════════════════════════════════════
  // PERSONAL INFORMATION
  // ═══════════════════════════════════════════════════════════════════════════════
  dateOfBirth   DateTime?
  gender        Gender?
  nationality   String?
  maritalStatus MaritalStatus?

  // Contact
  personalEmail    String?

  // Qatar-specific contact fields
  qatarMobile        String?
  otherMobileCode    String? @default("+91")
  otherMobileNumber  String?
  qatarZone          String?
  qatarStreet        String?
  qatarBuilding      String?
  qatarUnit          String?
  homeCountryAddress String?

  // Emergency Contacts - Local (Qatar)
  localEmergencyName      String?
  localEmergencyRelation  String?
  localEmergencyPhoneCode String? @default("+974")
  localEmergencyPhone     String?

  // Emergency Contacts - Home Country
  homeEmergencyName      String?
  homeEmergencyRelation  String?
  homeEmergencyPhoneCode String? @default("+91")
  homeEmergencyPhone     String?

  // ═══════════════════════════════════════════════════════════════════════════════
  // IDENTITY DOCUMENTS (Qatar specific)
  // ═══════════════════════════════════════════════════════════════════════════════
  qidNumber      String?
  qidExpiry      DateTime?
  passportNumber String?
  passportExpiry DateTime?

  // Visa & Work Permit
  visaType         String?
  visaExpiry       DateTime?
  workPermitNumber String?
  workPermitExpiry DateTime?

  // Health card
  healthCardExpiry DateTime?

  // Sponsorship
  sponsorshipType String? // Company/Family/Work Permit

  // Driving
  hasDrivingLicense Boolean   @default(false)
  drivingLicense    String?
  licenseExpiry     DateTime?

  // ═══════════════════════════════════════════════════════════════════════════════
  // EDUCATION
  // ═══════════════════════════════════════════════════════════════════════════════
  highestQualification String?
  specialization       String?
  institutionName      String?
  graduationYear       Int?
  languagesKnown       String? // JSON array
  skillsCertifications String? // JSON array

  // ═══════════════════════════════════════════════════════════════════════════════
  // DOCUMENTS (Supabase storage URLs)
  // ═══════════════════════════════════════════════════════════════════════════════
  qidUrl          String?
  passportCopyUrl String?
  photoUrl        String?
  contractCopyUrl String?
  contractExpiry  DateTime?

  // ═══════════════════════════════════════════════════════════════════════════════
  // BANKING & PAYROLL
  // ═══════════════════════════════════════════════════════════════════════════════
  bankName      String?
  bankBranch    String?
  accountNumber String?
  iban          String?
  swiftCode     String?

  // ═══════════════════════════════════════════════════════════════════════════════
  // LEAVE-SPECIFIC FLAGS
  // ═══════════════════════════════════════════════════════════════════════════════
  hajjLeaveTaken          Boolean @default(false) // Qatar law: Hajj leave can only be taken once
  bypassNoticeRequirement Boolean @default(false) // Admin override for advance notice

  // ═══════════════════════════════════════════════════════════════════════════════
  // ONBOARDING & STATUS
  // ═══════════════════════════════════════════════════════════════════════════════
  onboardingStep     Int              @default(0)
  onboardingComplete Boolean          @default(false)
  status             TeamMemberStatus @default(ACTIVE)

  // Soft-delete
  isDeleted           Boolean   @default(false)
  deletedAt           DateTime?
  scheduledDeletionAt DateTime?
  deletedByMemberId   String?

  // ═══════════════════════════════════════════════════════════════════════════════
  // TIMESTAMPS
  // ═══════════════════════════════════════════════════════════════════════════════
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  joinedAt  DateTime @default(now())

  // ═══════════════════════════════════════════════════════════════════════════════
  // RELATIONS
  // ═══════════════════════════════════════════════════════════════════════════════

  // Manager/Direct Reports (self-relation)
  reportingTo   TeamMember?  @relation("ManagerRelation", fields: [reportingToId], references: [id])
  directReports TeamMember[] @relation("ManagerRelation")

  // Assets
  assets                       Asset[]               @relation("MemberAssets")
  assetsDisposed               Asset[]               @relation("AssetDisposer")
  assetsDeleted                Asset[]               @relation("AssetDeleter")
  assetHistoryFrom             AssetHistory[]        @relation("AssetHistoryFromMember")
  assetHistoryTo               AssetHistory[]        @relation("AssetHistoryToMember")
  assetHistoryPerformed        AssetHistory[]        @relation("AssetHistoryPerformer")
  assetRequests                AssetRequest[]        @relation("AssetRequestMember")
  assetRequestsAssigned        AssetRequest[]        @relation("AssetRequestAssigner")
  assetRequestsProcessed       AssetRequest[]        @relation("AssetRequestProcessor")
  assetRequestHistoryPerformed AssetRequestHistory[] @relation("AssetRequestHistoryPerformer")
  maintenancePerformed         MaintenanceRecord[]   @relation("MaintenancePerformer")

  // Subscriptions
  subscriptions                Subscription[]
  subscriptionHistoryPerformed SubscriptionHistory[] @relation("SubscriptionHistoryPerformer")
  subscriptionHistoryOldMember SubscriptionHistory[] @relation("SubscriptionHistoryOldMember")
  subscriptionHistoryNewMember SubscriptionHistory[] @relation("SubscriptionHistoryNewMember")

  // Suppliers
  approvedSuppliers   Supplier[]           @relation("SupplierApprover")
  supplierEngagements SupplierEngagement[]

  // Activity & Settings
  activityLogs          ActivityLog[]
  systemSettingsUpdated SystemSettings[] @relation("SystemSettingsUpdater")

  // Purchase Requests
  purchaseRequests         PurchaseRequest[]        @relation("PurchaseRequester")
  reviewedPurchaseRequests PurchaseRequest[]        @relation("PurchaseReviewer")
  purchaseRequestHistory   PurchaseRequestHistory[] @relation("PurchaseRequestHistoryPerformer")

  // Leave Management
  leaveRequests         LeaveRequest[]        @relation("LeaveRequests")
  leaveApprovals        LeaveRequest[]        @relation("LeaveApprovals")
  leaveRequestsCreated  LeaveRequest[]        @relation("LeaveRequestCreator")
  leaveBalances         LeaveBalance[]
  leaveHistoryPerformed LeaveRequestHistory[] @relation("LeaveHistoryPerformer")

  // Payroll
  salaryStructure         SalaryStructure?
  salaryHistoryPerformed  SalaryStructureHistory[] @relation("SalaryHistoryPerformer")
  payslips                Payslip[]
  submittedPayrolls       PayrollRun[]             @relation("PayrollSubmitter")
  approvedPayrolls        PayrollRun[]             @relation("PayrollApprover")
  processedPayrolls       PayrollRun[]             @relation("PayrollProcessor")
  paidPayrolls            PayrollRun[]             @relation("PayrollPayer")
  createdPayrolls         PayrollRun[]             @relation("PayrollCreator")
  payrollHistoryPerformed PayrollHistory[]         @relation("PayrollHistoryPerformer")
  employeeLoans           EmployeeLoan[]
  approvedLoans           EmployeeLoan[]           @relation("LoanApprover")
  createdLoans            EmployeeLoan[]           @relation("LoanCreator")
  recordedRepayments      LoanRepayment[]          @relation("RepaymentRecorder")

  // Company Documents
  companyDocumentsCreated CompanyDocument[] @relation("CompanyDocumentCreator")

  // Notifications
  notifications Notification[] @relation("MemberNotifications")

  // Approvals
  approvalSteps ApprovalStep[] @relation("ApprovalStepApprover")

  // Depreciation
  depreciationRecords DepreciationRecord[] @relation("DepreciationRecordCalculator")

  // Chat
  chatConversations ChatConversation[]
  aiChatUsage       AIChatUsage[]
  aiChatAuditLogs   AIChatAuditLog[]

  // WhatsApp
  whatsAppPhone                WhatsAppUserPhone?
  whatsAppPromptSnoozedUntil   DateTime?           // User clicked "Remind me later"

  // Profile change requests
  changeRequests ProfileChangeRequest[]

  // ═══════════════════════════════════════════════════════════════════════════════
  // INDEXES
  // ═══════════════════════════════════════════════════════════════════════════════
  @@unique([tenantId, email])
  @@unique([tenantId, employeeCode])
  @@index([tenantId])
  @@index([tenantId, isEmployee])
  @@index([tenantId, isOnWps])
  @@index([tenantId, status])
  @@index([tenantId, isAdmin])
  @@index([tenantId, canApprove])
  @@index([tenantId, reportingToId])
  @@index([email])
  @@index([resetToken])
  @@index([setupToken])
  @@index([scheduledDeletionAt])
  @@index([qidNumber])
  @@index([passportNumber])
  @@index([employeeCode])
  @@index([qidExpiry])
  @@index([passportExpiry])
  @@index([healthCardExpiry])
  @@index([contractExpiry])
  @@index([licenseExpiry])
  @@index([tenantId, qidExpiry])
  @@index([tenantId, passportExpiry])
  @@index([tenantId, contractExpiry])
  @@index([tenantId, dateOfJoining])
  @@index([tenantId, dateOfLeaving])
  @@index([tenantId, dateOfBirth]) // For birthday queries
  @@index([tenantId, isDeleted]) // For soft-delete queries
}

// ═══════════════════════════════════════════════════════════════════════════════
// IMPERSONATION TOKEN REVOCATION (Super Admin Security)
// ═══════════════════════════════════════════════════════════════════════════════

model RevokedImpersonationToken {
  id        String   @id @default(cuid())
  jti       String   @unique // JWT ID from the impersonation token
  revokedAt DateTime @default(now())
  revokedBy String // Super admin ID who revoked
  reason    String? // Optional reason for revocation

  // Token metadata (for audit purposes)
  superAdminId     String // Original token issuer
  organizationId   String // Target organization
  organizationSlug String
  issuedAt         DateTime // When the original token was issued
  expiresAt        DateTime // When the original token would have expired

  @@index([jti])
  @@index([superAdminId])
  @@index([expiresAt]) // For cleanup of expired entries
}

model Asset {
  id               String         @id @default(cuid())
  tenantId         String
  tenant           Organization   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assetTag         String? // #1 Asset ID/Tag (format: ORG-CAT-YYSEQ e.g., BCE-CP-25001)
  type             String // #2 Asset Type (Laptop, Mouse, Monitor, etc.) - sub-type within category
  categoryId       String? // FK to AssetCategory
  assetCategory    AssetCategory? @relation(fields: [categoryId], references: [id])
  brand            String? // #4 Brand/Manufacturer (Apple, Dell, HP, etc.)
  model            String // #5 Model/Version (MacBook Pro 16", Dell XPS 15, etc.)
  serial           String? // #6 Serial Number
  configuration    String? // #7 Configuration/Specs (16GB RAM, 512GB SSD, etc.)
  purchaseDate     DateTime? // #8 Purchase Date
  warrantyExpiry   DateTime? // #9 Warranty Expiry
  supplier         String? // #10 Supplier/Vendor (where purchased from)
  invoiceNumber    String? // #12 Invoice/PO Number
  assignedMemberId String? // #13 Assigned To (TeamMember)
  assignedMember   TeamMember?    @relation("MemberAssets", fields: [assignedMemberId], references: [id])
  assignmentDate   DateTime? // When the asset was assigned to current member
  status           AssetStatus    @default(IN_USE) // #14 Status/Condition
  price            Decimal? // #15 Cost/Value
  priceCurrency    String?        @default("QAR")
  priceQAR         Decimal?

  // Additional fields
  notes      String? // General notes/remarks about the asset
  locationId String? // FK to Location
  location   Location? @relation(fields: [locationId], references: [id])
  isShared   Boolean   @default(false) // Shared/common resource (e.g., printer, conference room equipment)

  // Depreciation fields
  depreciationCategoryId  String?
  depreciationCategory    DepreciationCategory? @relation(fields: [depreciationCategoryId], references: [id])
  salvageValue            Decimal?              @default(0) @db.Decimal(12, 2)
  customUsefulLifeMonths  Int? // Override category default if needed
  depreciationStartDate   DateTime? // Defaults to purchaseDate
  accumulatedDepreciation Decimal?              @default(0) @db.Decimal(12, 2)
  netBookValue            Decimal?              @db.Decimal(12, 2)
  lastDepreciationDate    DateTime?
  isFullyDepreciated      Boolean               @default(false)

  // Disposal tracking (IFRS/IAS 16 compliant)
  disposalDate         DateTime?
  disposalMethod       DisposalMethod?
  disposalProceeds     Decimal?        @db.Decimal(12, 2) // Sale price / proceeds
  disposalNotes        String? // Reason/notes for disposal
  disposalNetBookValue Decimal?        @db.Decimal(12, 2) // NBV at disposal date (immutable)
  disposalGainLoss     Decimal?        @db.Decimal(12, 2) // Gain (+) or Loss (-)
  disposedById         String?
  disposedBy           TeamMember?     @relation("AssetDisposer", fields: [disposedById], references: [id])

  // Soft delete (7-day recovery window)
  deletedAt   DateTime?
  deletedById String?
  deletedBy   TeamMember? @relation("AssetDeleter", fields: [deletedById], references: [id])

  // Relations & Metadata
  history             AssetHistory[]
  maintenanceRecords  MaintenanceRecord[]
  assetRequests       AssetRequest[]
  companyDocuments    CompanyDocument[] // Vehicle documents (insurance, istimara)
  depreciationRecords DepreciationRecord[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@unique([tenantId, assetTag])
  @@index([warrantyExpiry])
  @@index([brand])
  @@index([model])
  @@index([type])
  @@index([serial])
  @@index([assetTag])
  @@index([categoryId])
  @@index([locationId])
  @@index([tenantId])
  @@index([tenantId, status]) // For status filtering
  @@index([tenantId, type]) // For type filtering
  @@index([tenantId, categoryId]) // For category filtering
  @@index([tenantId, assignedMemberId]) // For assignment filtering
  @@index([tenantId, status, disposalDate]) // For disposal reporting
  @@index([tenantId, deletedAt]) // For soft delete queries
}

// ═══════════════════════════════════════════════════════════════════════════════
// ASSET CATEGORY - Universal categories with tenant customization
// ═══════════════════════════════════════════════════════════════════════════════

model AssetCategory {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code        String // 2-letter code (e.g., "CP", "MO", "DP")
  name        String // Human-readable name (e.g., "Computing")
  description String?
  isActive    Boolean @default(true)
  isDefault   Boolean @default(false) // True for seeded categories
  sortOrder   Int     @default(0)

  // Default depreciation category for assets in this category
  defaultDepreciationCategoryId String?
  defaultDepreciationCategory   DepreciationCategory? @relation("DefaultDepreciationCategory", fields: [defaultDepreciationCategoryId], references: [id], onDelete: SetNull)

  assets       Asset[]
  typeMappings AssetTypeMapping[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

// ═══════════════════════════════════════════════════════════════════════════════
// ASSET TYPE MAPPING - Custom type-to-category mappings per organization
// ═══════════════════════════════════════════════════════════════════════════════

model AssetTypeMapping {
  id         String        @id @default(cuid())
  tenantId   String
  tenant     Organization  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  typeName   String // e.g., "Drawings", "Blueprint"
  categoryId String
  category   AssetCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, typeName])
  @@index([tenantId])
}

// ═══════════════════════════════════════════════════════════════════════════════
// LOCATION - Physical locations for assets (multi-location organizations)
// ═══════════════════════════════════════════════════════════════════════════════

model Location {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String // "Main Office", "Warehouse A", "Branch - Doha"
  description String?
  isActive    Boolean @default(true)

  assets Asset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

enum AssetHistoryAction {
  ASSIGNED
  UNASSIGNED
  STATUS_CHANGED
  LOCATION_CHANGED
  CREATED
  UPDATED
  CORRECTION // Indicates this entry corrects a previous entry
}

model AssetHistory {
  id               String             @id @default(cuid())
  tenantId         String
  tenant           Organization       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assetId          String
  asset            Asset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  action           AssetHistoryAction
  fromMemberId     String?
  fromMember       TeamMember?        @relation("AssetHistoryFromMember", fields: [fromMemberId], references: [id])
  toMemberId       String?
  toMember         TeamMember?        @relation("AssetHistoryToMember", fields: [toMemberId], references: [id])
  fromStatus       AssetStatus?
  toStatus         AssetStatus?
  fromLocation     String?
  toLocation       String?
  notes            String?
  performedById    String?
  performedBy      TeamMember?        @relation("AssetHistoryPerformer", fields: [performedById], references: [id])
  assignmentDate   DateTime? // When asset was assigned (for ASSIGNED action)
  returnDate       DateTime? // When asset was returned (for UNASSIGNED action)
  statusChangeDate DateTime? // When status changed (for STATUS_CHANGED action)
  createdAt        DateTime           @default(now())

  @@index([assetId])
  @@index([createdAt])
  @@index([toMemberId])
  @@index([tenantId])
}

model Subscription {
  id                    String                @id @default(cuid())
  tenantId              String
  tenant                Organization          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscriptionTag       String? // Auto-generated tag like BEC-SUB-2501-001
  serviceName           String
  category              String?
  accountId             String?
  purchaseDate          DateTime?
  renewalDate           DateTime?
  billingCycle          BillingCycle
  costPerCycle          Decimal?
  costCurrency          String?               @default("QAR")
  costQAR               Decimal?
  vendor                String?
  status                SubscriptionStatus    @default(ACTIVE)
  assignedMemberId      String?
  assignedMember        TeamMember?           @relation(fields: [assignedMemberId], references: [id])
  autoRenew             Boolean               @default(true)
  paymentMethod         String?
  notes                 String?
  lastActiveRenewalDate DateTime? // Track last renewal before cancel
  cancelledAt           DateTime? // When it was cancelled
  reactivatedAt         DateTime? // When it was last reactivated
  history               SubscriptionHistory[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  @@unique([tenantId, subscriptionTag])
  @@index([renewalDate])
  @@index([status])
  @@index([category])
  @@index([serviceName])
  @@index([vendor])
  @@index([accountId])
  @@index([subscriptionTag])
  @@index([tenantId])
  @@index([tenantId, status, renewalDate]) // Composite for "active subscriptions expiring soon" queries
}

enum SubscriptionHistoryAction {
  CREATED
  REACTIVATED
  CANCELLED
  RENEWED
  REASSIGNED
}

model SubscriptionHistory {
  id               String                    @id @default(cuid())
  subscriptionId   String
  subscription     Subscription              @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  action           SubscriptionHistoryAction
  oldStatus        SubscriptionStatus?
  newStatus        SubscriptionStatus?
  oldRenewalDate   DateTime?
  newRenewalDate   DateTime?
  reactivationDate DateTime? // Date when service was reactivated
  assignmentDate   DateTime? // Date when member was assigned/reassigned
  oldMemberId      String? // Previous assigned member
  newMemberId      String? // New assigned member
  oldMember        TeamMember?               @relation("SubscriptionHistoryOldMember", fields: [oldMemberId], references: [id])
  newMember        TeamMember?               @relation("SubscriptionHistoryNewMember", fields: [newMemberId], references: [id])
  notes            String?
  performedById    String?
  performedBy      TeamMember?               @relation("SubscriptionHistoryPerformer", fields: [performedById], references: [id])
  createdAt        DateTime                  @default(now())

  @@index([subscriptionId])
  @@index([createdAt])
}

model ActivityLog {
  id            String       @id @default(cuid())
  tenantId      String
  tenant        Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actorMemberId String?
  actorMember   TeamMember?  @relation(fields: [actorMemberId], references: [id])
  action        String
  entityType    String?
  entityId      String?
  payload       Json?
  at            DateTime     @default(now())

  @@index([actorMemberId])
  @@index([at])
  @@index([tenantId])
  @@index([tenantId, at]) // For sorted activity queries per tenant
}

// ═══════════════════════════════════════════════════════════════════════════════
// NOTIFICATION SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════

model Notification {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recipientId String
  recipient   TeamMember   @relation("MemberNotifications", fields: [recipientId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String
  link    String? // URL to navigate when clicked

  entityType String? // Related entity type (e.g., "LeaveRequest", "Asset")
  entityId   String? // Related entity ID

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([recipientId])
  @@index([recipientId, isRead])
  @@index([createdAt])
  @@index([tenantId])
  @@index([tenantId, recipientId, isRead]) // Composite for unread notifications per user per tenant
}

// Email failure log for super admin monitoring
model EmailFailureLog {
  id       String        @id @default(cuid())
  tenantId String?
  tenant   Organization? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Module context
  module String // e.g., "assets", "leave", "users"
  action String // e.g., "assignment", "approval"

  // Organization info (denormalized for when tenant is deleted)
  organizationName String?
  organizationSlug String?

  // Recipient info
  recipientEmail String
  recipientName  String?

  // Email details
  emailSubject String

  // Error info
  error     String  @db.Text
  errorCode String?

  // Additional context
  metadata Json?

  // Resolution tracking
  resolved        Boolean   @default(false)
  resolvedAt      DateTime?
  resolvedBy      String? // Super admin who resolved
  resolutionNotes String?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([module])
  @@index([resolved])
  @@index([createdAt])
  @@index([tenantId, createdAt])
}

// ═══════════════════════════════════════════════════════════════════════════════
// ERROR LOG (Centralized error tracking across all services)
// ═══════════════════════════════════════════════════════════════════════════════

model ErrorLog {
  id       String        @id @default(cuid())
  tenantId String?
  tenant   Organization? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  // Error classification
  type   String // API_ERROR, CLIENT_ERROR, SERVICE_ERROR
  source String // Module or component (e.g., "assets", "leave", "ui/dashboard")
  action String? // Specific action (e.g., "create", "approve")

  // Request info
  requestId String?
  method    String? // GET, POST, etc.
  path      String? // /api/assets/[id]

  // User info
  userId    String?
  userEmail String?
  userRole  String? // ADMIN, MEMBER, etc.

  // Error details
  message    String  @db.Text
  stack      String? @db.Text
  statusCode Int?
  errorCode  String? // Custom error codes

  // Additional context
  metadata  Json?
  userAgent String?

  // Severity
  severity String @default("error") // error, warning, critical

  // Resolution tracking
  resolved        Boolean   @default(false)
  resolvedAt      DateTime?
  resolvedBy      String? // Super admin who resolved
  resolutionNotes String?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([type])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
  @@index([userId])
  @@index([tenantId, createdAt])
}

// ═══════════════════════════════════════════════════════════════════════════════
// MULTI-LEVEL APPROVAL WORKFLOW MODELS
// ═══════════════════════════════════════════════════════════════════════════════

model ApprovalPolicy {
  id        String         @id @default(cuid())
  tenantId  String
  tenant    Organization   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  module    ApprovalModule
  isActive  Boolean        @default(true)
  minAmount Decimal?       @db.Decimal(12, 2) // For purchase/asset thresholds
  maxAmount Decimal?       @db.Decimal(12, 2)
  minDays   Int? // For leave request thresholds
  maxDays   Int?
  priority  Int            @default(0) // Higher = checked first
  version   Int            @default(1) // Incremented on each update for audit trail

  levels ApprovalLevel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([module, isActive])
  @@index([priority])
  @@index([tenantId])
}

model ApprovalLevel {
  id           String         @id @default(cuid())
  policyId     String
  policy       ApprovalPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  levelOrder   Int // 1, 2, 3... defines approval sequence
  approverRole Role // MANAGER, HR_MANAGER, FINANCE_MANAGER, DIRECTOR

  @@unique([policyId, levelOrder])
  @@index([policyId])
}

model ApprovalStep {
  id            String         @id @default(cuid())
  tenantId      String
  tenant        Organization   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entityType    ApprovalModule // Which module (LEAVE_REQUEST, PURCHASE_REQUEST, ASSET_REQUEST)
  entityId      String // The ID of the request being approved
  levelOrder    Int // Which level in the chain
  requiredRole  Role // Role required to approve this step
  policyId      String? // Reference to the policy used (for audit trail)
  policyVersion Int? // Version of the policy when chain was created

  approverId String? // Member who took action (null if pending)
  approver   TeamMember? @relation("ApprovalStepApprover", fields: [approverId], references: [id])

  status   ApprovalStepStatus @default(PENDING)
  actionAt DateTime? // When action was taken
  notes    String? // Approver notes

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([requiredRole, status])
  @@index([approverId])
  @@index([tenantId])
  @@index([tenantId, status, requiredRole])
  @@index([tenantId, approverId, status])
  @@index([policyId])
}

model MaintenanceRecord {
  id              String       @id @default(cuid())
  tenantId        String
  tenant          Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assetId         String
  asset           Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)
  maintenanceDate DateTime
  notes           String?
  performedById   String?
  performedBy     TeamMember?  @relation("MaintenancePerformer", fields: [performedById], references: [id], onDelete: SetNull)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([assetId])
  @@index([maintenanceDate])
  @@index([tenantId])
  @@index([performedById])
}

model Supplier {
  id                     String               @id @default(cuid())
  tenantId               String
  tenant                 Organization         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  suppCode               String? // Auto-generated SUPP-XXXX on approval
  name                   String
  category               String // Material category
  address                String?
  city                   String?
  country                String?
  website                String?
  establishmentYear      Int?
  primaryContactName     String?
  primaryContactTitle    String?
  primaryContactEmail    String?
  primaryContactMobile   String?
  secondaryContactName   String?
  secondaryContactTitle  String?
  secondaryContactEmail  String?
  secondaryContactMobile String?
  paymentTerms           String?
  additionalInfo         String? // Additional information (portfolio, certifications, etc.)
  status                 SupplierStatus       @default(PENDING)
  rejectionReason        String?
  approvedAt             DateTime?
  approvedById           String?
  approvedBy             TeamMember?          @relation("SupplierApprover", fields: [approvedById], references: [id])
  engagements            SupplierEngagement[]
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  @@unique([tenantId, suppCode])
  @@index([status])
  @@index([suppCode])
  @@index([createdAt])
  @@index([name])
  @@index([category])
  @@index([tenantId])
}

model SupplierEngagement {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplierId  String
  supplier    Supplier     @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  date        DateTime
  notes       String
  rating      Int? // 1-5 star rating (optional)
  createdById String
  createdBy   TeamMember   @relation(fields: [createdById], references: [id])
  createdAt   DateTime     @default(now())

  @@index([supplierId])
  @@index([date])
  @@index([tenantId])
}

// SECURITY NOTE: AppSetting is intentionally NOT tenant-scoped
// This is for platform-wide settings managed by super admins only
// For tenant-specific settings, use SystemSettings model instead
model AppSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model SystemSettings {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key         String // Removed @unique - now part of composite unique constraint
  value       String
  updatedById String?
  updatedBy   TeamMember?  @relation("SystemSettingsUpdater", fields: [updatedById], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([tenantId, key]) // SECURITY: Each tenant can have their own settings
  @@index([key])
  @@index([tenantId])
}

// HRProfile model REMOVED - Use TeamMember instead
// All HR data fields are now in TeamMember model
// Removed in schema optimization for production

enum ProfileChangeRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// ===== Purchase Request Module Enums =====

enum PurchaseRequestStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  COMPLETED
}

enum PurchaseRequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PurchaseType {
  HARDWARE
  SOFTWARE_SUBSCRIPTION
  EQUIPMENT
  FURNITURE
  OFFICE_SUPPLIES
  INVENTORY
  SERVICES
  MAINTENANCE
  UTILITIES
  MARKETING
  TRAVEL
  TRAINING
  OTHER
}

enum CostType {
  OPERATING_COST
  PROJECT_COST
}

enum PaymentMode {
  BANK_TRANSFER
  CREDIT_CARD
  CASH
  CHEQUE
  INTERNAL_TRANSFER
}

model ProfileChangeRequest {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Link to TeamMember
  memberId String
  member   TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Request details
  description String // What changes the member is requesting
  status      ProfileChangeRequestStatus @default(PENDING)

  // Resolution
  resolvedById  String?
  resolvedAt    DateTime?
  resolverNotes String? // Admin notes when resolving

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId])
  @@index([status])
  @@index([createdAt])
  @@index([tenantId])
}

// ===== Purchase Request Module Models =====

model PurchaseRequest {
  id              String                  @id @default(cuid())
  tenantId        String
  tenant          Organization            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  referenceNumber String // {PREFIX}-PR-YYMM-XXXX (tenant-scoped unique)
  requestDate     DateTime                @default(now())
  status          PurchaseRequestStatus   @default(PENDING)
  priority        PurchaseRequestPriority @default(MEDIUM)

  // Requester info (auto-populated from logged-in member)
  requesterId String
  requester   TeamMember @relation("PurchaseRequester", fields: [requesterId], references: [id])

  // Request details
  title         String
  description   String?
  justification String? // Business justification
  neededByDate  DateTime? // When items are needed

  // Purchase Type & Cost Details (from prototype)
  purchaseType PurchaseType @default(OTHER)
  costType     CostType     @default(OPERATING_COST)
  projectName  String? // Required when costType is PROJECT_COST
  paymentMode  PaymentMode  @default(BANK_TRANSFER)

  // Vendor Details
  vendorName    String?
  vendorContact String?
  vendorEmail   String?

  // Additional Notes
  additionalNotes String?

  // Totals
  totalAmount        Decimal  @db.Decimal(12, 2)
  currency           String   @default("QAR")
  totalAmountQAR     Decimal? @db.Decimal(12, 2)
  totalOneTime       Decimal? @db.Decimal(12, 2) // One-time costs total
  totalMonthly       Decimal? @db.Decimal(12, 2) // Monthly recurring total
  totalContractValue Decimal? @db.Decimal(12, 2) // Total contract value

  // Approval workflow
  reviewedById String?
  reviewedBy   TeamMember? @relation("PurchaseReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  reviewNotes  String?

  // Completion
  completedAt     DateTime?
  completionNotes String?

  // Relations
  items   PurchaseRequestItem[]
  history PurchaseRequestHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, referenceNumber])
  @@index([requesterId])
  @@index([status])
  @@index([referenceNumber])
  @@index([createdAt])
  @@index([purchaseType])
  @@index([costType])
  @@index([tenantId])
}

model PurchaseRequestItem {
  id                String          @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  itemNumber    Int // Line item number (1, 2, 3...)
  description   String
  quantity      Int      @default(1)
  unitPrice     Decimal  @db.Decimal(12, 2)
  currency      String   @default("QAR")
  unitPriceQAR  Decimal? @db.Decimal(12, 2)
  totalPrice    Decimal  @db.Decimal(12, 2) // quantity * unitPrice
  totalPriceQAR Decimal? @db.Decimal(12, 2)

  // Subscription/recurring fields (for SOFTWARE_SUBSCRIPTION type)
  billingCycle   BillingCycle @default(ONE_TIME) // ONE_TIME, MONTHLY, YEARLY
  durationMonths Int? // Duration in months (for monthly billing)
  amountPerCycle Decimal?     @db.Decimal(12, 2) // Recurring cost per cycle

  // Product details
  productUrl String? // Product link URL

  category String? // IT Equipment, Office Supplies, etc.
  supplier String? // Preferred supplier
  notes    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([purchaseRequestId])
  @@index([billingCycle])
}

model PurchaseRequestHistory {
  id                String          @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  action         String // CREATED, STATUS_CHANGED, UPDATED, ITEM_ADDED, ITEM_REMOVED
  previousStatus PurchaseRequestStatus?
  newStatus      PurchaseRequestStatus?

  performedById String
  performedBy   TeamMember @relation("PurchaseRequestHistoryPerformer", fields: [performedById], references: [id])

  details String? // JSON or text description of changes

  createdAt DateTime @default(now())

  @@index([purchaseRequestId])
  @@index([performedById])
  @@index([createdAt])
}

// ===== Leave Management Module Models =====

model LeaveType {
  id                  String       @id @default(cuid())
  tenantId            String
  tenant              Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name                String // Annual, Sick, Maternity, Hajj, Paternity, Unpaid, Compassionate
  description         String?
  color               String       @default("#3B82F6") // For calendar display
  defaultDays         Int          @default(0) // Default annual entitlement
  requiresApproval    Boolean      @default(true)
  requiresDocument    Boolean      @default(false) // Medical certificate etc.
  isPaid              Boolean      @default(true)
  isActive            Boolean      @default(true)
  maxConsecutiveDays  Int? // Max consecutive days allowed
  minNoticeDays       Int          @default(0) // Advance notice required
  allowCarryForward   Boolean      @default(false)
  maxCarryForwardDays Int?

  // Qatar Labor Law Fields
  minimumServiceMonths    Int           @default(0) // Minimum months of service required (e.g., 3 for sick, 12 for annual/Hajj)
  isOnceInEmployment      Boolean       @default(false) // Can only use once (Hajj leave)
  serviceBasedEntitlement Json? // Service-based days: {"12": 21, "60": 28} (months: days) for annual leave
  payTiers                Json? // For sick leave: [{"days": 14, "payPercent": 100}, {"days": 28, "payPercent": 50}, {"days": 42, "payPercent": 0}]
  category                LeaveCategory @default(STANDARD) // STANDARD auto-init, others admin-assigned
  genderRestriction       String? // "MALE", "FEMALE", or null for any
  accrualBased            Boolean       @default(false) // If true, entitlement accrues monthly

  leaveRequests LeaveRequest[]
  leaveBalances LeaveBalance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([isActive])
  @@index([category])
  @@index([tenantId])
}

model PublicHoliday {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String // "Eid al-Fitr", "Qatar National Day"
  description String?
  startDate   DateTime
  endDate     DateTime // Same as startDate for single-day holidays
  year        Int // 2024, 2025, etc.
  isRecurring Boolean  @default(false) // For fixed-date holidays
  color       String   @default("#EF4444") // Red for holidays

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name, year])
  @@index([tenantId])
  @@index([tenantId, year])
  @@index([tenantId, startDate, endDate])
}

model LeaveBalance {
  id              String       @id @default(cuid())
  tenantId        String
  tenant          Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  memberId        String
  member          TeamMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  leaveTypeId     String
  leaveType       LeaveType    @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)
  year            Int // Year for balance
  entitlement     Decimal      @default(0) // Total days entitled
  used            Decimal      @default(0) // Days used
  pending         Decimal      @default(0) // Days in pending requests
  carriedForward  Decimal      @default(0) // From previous year
  adjustment      Decimal      @default(0) // Manual adjustments (+/-)
  adjustmentNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, memberId, leaveTypeId, year])
  @@index([memberId])
  @@index([leaveTypeId])
  @@index([year])
  @@index([tenantId])
}

model LeaveRequest {
  id            String           @id @default(cuid())
  tenantId      String
  tenant        Organization     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requestNumber String // {PREFIX}-LR-XXXXX (tenant-scoped unique)
  memberId      String
  member        TeamMember       @relation("LeaveRequests", fields: [memberId], references: [id], onDelete: Cascade)
  leaveTypeId   String
  leaveType     LeaveType        @relation(fields: [leaveTypeId], references: [id])
  startDate     DateTime
  endDate       DateTime
  requestType   LeaveRequestType @default(FULL_DAY)
  totalDays     Decimal // Calculated working days
  reason        String?
  documentUrl   String? // Supporting document

  status LeaveStatus @default(PENDING)

  // Approval
  approverId    String?
  approver      TeamMember? @relation("LeaveApprovals", fields: [approverId], references: [id])
  approvedAt    DateTime?
  approverNotes String?

  // Rejection
  rejectedAt      DateTime?
  rejectionReason String?

  // Cancellation
  cancelledAt        DateTime?
  cancellationReason String?

  // On behalf of: track who submitted if different from member
  createdById String?
  createdBy   TeamMember? @relation("LeaveRequestCreator", fields: [createdById], references: [id])

  // Emergency contact during leave
  emergencyContact String?
  emergencyPhone   String?

  history LeaveRequestHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, requestNumber])
  @@index([memberId])
  @@index([leaveTypeId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, memberId])
  @@index([tenantId, startDate, status])
}

model LeaveRequestHistory {
  id             String       @id @default(cuid())
  leaveRequestId String
  leaveRequest   LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)

  action    String // CREATED, SUBMITTED, APPROVED, REJECTED, CANCELLED, UPDATED
  oldStatus LeaveStatus?
  newStatus LeaveStatus?
  changes   Json?
  notes     String?

  performedById String
  performedBy   TeamMember @relation("LeaveHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([leaveRequestId])
  @@index([createdAt])
}

// ===== Payroll Management Module Enums =====

enum PayrollStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PROCESSED
  PAID
  CANCELLED
}

enum LoanStatus {
  ACTIVE
  PAUSED
  COMPLETED
  WRITTEN_OFF
}

enum DeductionType {
  UNPAID_LEAVE
  LOAN_REPAYMENT
  ADVANCE_DEDUCTION
  OTHER
}

// ===== Payroll Management Module Models =====

model SalaryStructure {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  memberId String       @unique
  member   TeamMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Core salary components (all stored in QAR)
  basicSalary            Decimal @db.Decimal(12, 2)
  housingAllowance       Decimal @default(0) @db.Decimal(12, 2)
  transportAllowance     Decimal @default(0) @db.Decimal(12, 2)
  foodAllowance          Decimal @default(0) @db.Decimal(12, 2)
  phoneAllowance         Decimal @default(0) @db.Decimal(12, 2)
  otherAllowances        Decimal @default(0) @db.Decimal(12, 2)
  otherAllowancesDetails String? // JSON: [{ name, amount }]

  // Total calculated monthly salary
  grossSalary Decimal @db.Decimal(12, 2)

  // Currency (for reference, values stored in QAR)
  currency String @default("QAR")

  // Effective dates
  effectiveFrom DateTime
  effectiveTo   DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  history SalaryStructureHistory[]

  @@index([memberId])
  @@index([effectiveFrom])
  @@index([isActive])
  @@index([tenantId])
}

model SalaryStructureHistory {
  id                String          @id @default(cuid())
  salaryStructureId String
  salaryStructure   SalaryStructure @relation(fields: [salaryStructureId], references: [id], onDelete: Cascade)

  action         String // CREATED, UPDATED, DEACTIVATED
  changes        Json? // Field changes
  previousValues Json? // Previous salary values
  notes          String?

  performedById String
  performedBy   TeamMember @relation("SalaryHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([salaryStructureId])
  @@index([createdAt])
}

model PayrollRun {
  id              String       @id @default(cuid())
  tenantId        String
  tenant          Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  referenceNumber String // {PREFIX}-PAY-YYYY-MM-XXX (tenant-scoped unique)

  // Period
  year        Int
  month       Int // 1-12
  periodStart DateTime
  periodEnd   DateTime

  // Status workflow
  status PayrollStatus @default(DRAFT)

  // Totals
  totalGross      Decimal @db.Decimal(14, 2)
  totalDeductions Decimal @db.Decimal(14, 2)
  totalNet        Decimal @db.Decimal(14, 2)
  employeeCount   Int     @default(0)

  // WPS
  wpsFileGenerated Boolean   @default(false)
  wpsFileUrl       String?
  wpsGeneratedAt   DateTime?

  // Workflow
  submittedById String?
  submittedBy   TeamMember? @relation("PayrollSubmitter", fields: [submittedById], references: [id])
  submittedAt   DateTime?

  approvedById  String?
  approvedBy    TeamMember? @relation("PayrollApprover", fields: [approvedById], references: [id])
  approvedAt    DateTime?
  approverNotes String?

  processedById String?
  processedBy   TeamMember? @relation("PayrollProcessor", fields: [processedById], references: [id])
  processedAt   DateTime?

  paidById         String?
  paidBy           TeamMember? @relation("PayrollPayer", fields: [paidById], references: [id])
  paidAt           DateTime?
  paymentReference String?

  createdById String
  createdBy   TeamMember @relation("PayrollCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payslips Payslip[]
  history  PayrollHistory[]

  @@unique([tenantId, year, month])
  @@unique([tenantId, referenceNumber])
  @@index([status])
  @@index([year, month])
  @@index([referenceNumber])
  @@index([tenantId])
  @@index([tenantId, status])
}

model PayrollHistory {
  id           String     @id @default(cuid())
  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)

  action         String // CREATED, STATUS_CHANGED, UPDATED, WPS_GENERATED
  previousStatus PayrollStatus?
  newStatus      PayrollStatus?
  changes        Json?
  notes          String?

  performedById String
  performedBy   TeamMember @relation("PayrollHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([payrollRunId])
  @@index([createdAt])
}

model Payslip {
  id            String       @id @default(cuid())
  tenantId      String
  tenant        Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payslipNumber String // {PREFIX}-PS-YYYY-MM-XXXXX (tenant-scoped unique)

  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)

  memberId String
  member   TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Salary Components (snapshot from SalaryStructure)
  basicSalary            Decimal @db.Decimal(12, 2)
  housingAllowance       Decimal @db.Decimal(12, 2)
  transportAllowance     Decimal @db.Decimal(12, 2)
  foodAllowance          Decimal @db.Decimal(12, 2)
  phoneAllowance         Decimal @db.Decimal(12, 2)
  otherAllowances        Decimal @db.Decimal(12, 2)
  otherAllowancesDetails String?

  grossSalary Decimal @db.Decimal(12, 2)

  // Deductions
  totalDeductions Decimal @db.Decimal(12, 2)

  // Net
  netSalary Decimal @db.Decimal(12, 2)

  // Payment Info (from TeamMember)
  bankName String?
  iban     String?

  // WPS Info (from TeamMember)
  qidNumber String?

  // Status
  isPaid Boolean   @default(false)
  paidAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deductions PayslipDeduction[]

  @@unique([payrollRunId, memberId])
  @@unique([tenantId, payslipNumber])
  @@index([payrollRunId])
  @@index([memberId])
  @@index([payslipNumber])
  @@index([tenantId])
  @@index([tenantId, isPaid])
}

model PayslipDeduction {
  id        String  @id @default(cuid())
  payslipId String
  payslip   Payslip @relation(fields: [payslipId], references: [id], onDelete: Cascade)

  type        DeductionType
  description String
  amount      Decimal       @db.Decimal(12, 2)

  // Reference to related entities
  leaveRequestId String? // If UNPAID_LEAVE
  loanId         String? // If LOAN_REPAYMENT
  advanceId      String? // If ADVANCE_DEDUCTION

  createdAt DateTime @default(now())

  @@index([payslipId])
  @@index([type])
}

model EmployeeLoan {
  id         String       @id @default(cuid())
  tenantId   String
  tenant     Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loanNumber String // {PREFIX}-LOAN-XXXXX (tenant-scoped unique)

  memberId String
  member   TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Loan Details
  type        String // LOAN, ADVANCE
  description String

  // Amounts
  principalAmount  Decimal @db.Decimal(12, 2)
  totalAmount      Decimal @db.Decimal(12, 2) // Including any interest/fees
  monthlyDeduction Decimal @db.Decimal(12, 2)

  // Repayment tracking
  totalPaid       Decimal @default(0) @db.Decimal(12, 2)
  remainingAmount Decimal @db.Decimal(12, 2)

  // Schedule
  startDate        DateTime // When deductions start
  endDate          DateTime? // Expected end date
  installments     Int // Number of monthly installments
  installmentsPaid Int       @default(0)

  status LoanStatus @default(ACTIVE)

  // Approval
  approvedById String?
  approvedBy   TeamMember? @relation("LoanApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  notes String?

  createdById String
  createdBy   TeamMember @relation("LoanCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  repayments LoanRepayment[]

  @@unique([tenantId, loanNumber])
  @@index([memberId])
  @@index([status])
  @@index([loanNumber])
  @@index([tenantId])
}

model LoanRepayment {
  id     String       @id @default(cuid())
  loanId String
  loan   EmployeeLoan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  amount    Decimal @db.Decimal(12, 2)
  payslipId String? // Link to payslip if deducted from salary

  // Payment details
  paymentDate   DateTime
  paymentMethod String // SALARY_DEDUCTION, CASH, BANK_TRANSFER
  reference     String?

  notes String?

  recordedById String
  recordedBy   TeamMember @relation("RepaymentRecorder", fields: [recordedById], references: [id])

  createdAt DateTime @default(now())

  @@index([loanId])
  @@index([paymentDate])
}

// ═══════════════════════════════════════════════════════════════════════════════
// ASSET REQUEST WORKFLOW - Employee requests, admin assignments, and returns
// ═══════════════════════════════════════════════════════════════════════════════

model AssetRequest {
  id            String             @id @default(cuid())
  tenantId      String
  tenant        Organization       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requestNumber String // {PREFIX}-AR-YYMMDD-XXX (tenant-scoped unique)
  type          AssetRequestType
  status        AssetRequestStatus

  // Asset being requested/assigned
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Target member (requester for EMPLOYEE_REQUEST, assignee for ADMIN_ASSIGNMENT)
  memberId String
  member   TeamMember @relation("AssetRequestMember", fields: [memberId], references: [id])

  // Request details
  reason String? // Reason for request/return
  notes  String? // Additional notes

  // For ADMIN_ASSIGNMENT: who initiated the assignment
  assignedById     String?
  assignedByMember TeamMember? @relation("AssetRequestAssigner", fields: [assignedById], references: [id])

  // Processing info (approve/reject/accept/decline)
  processedById     String?
  processedByMember TeamMember? @relation("AssetRequestProcessor", fields: [processedById], references: [id])
  processedAt       DateTime?
  processorNotes    String?

  // Optional expiry for pending requests
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  history AssetRequestHistory[]

  @@unique([tenantId, requestNumber])
  @@index([assetId])
  @@index([memberId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([tenantId])
  @@index([assetId, status, type]) // For pending request lookups on assets
}

model AssetRequestHistory {
  id             String       @id @default(cuid())
  assetRequestId String
  assetRequest   AssetRequest @relation(fields: [assetRequestId], references: [id], onDelete: Cascade)

  action    String // CREATED, STATUS_CHANGED, APPROVED, REJECTED, ACCEPTED, DECLINED, CANCELLED
  oldStatus AssetRequestStatus?
  newStatus AssetRequestStatus?
  notes     String?

  performedById String
  performedBy   TeamMember @relation("AssetRequestHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([assetRequestId])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════════════════════
// ASSET DEPRECIATION - Qatar Tax Rates & IFRS Compliance
// ═══════════════════════════════════════════════════════════════════════════════

model DepreciationCategory {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name            String // "Vehicles", "IT Equipment", etc.
  code            String // "VEHICLES", "IT_EQUIPMENT", etc.
  annualRate      Decimal @db.Decimal(5, 2) // 20.00, 33.33
  usefulLifeYears Int // 5, 3, etc.
  description     String?
  isActive        Boolean @default(true)

  assets          Asset[]
  assetCategories AssetCategory[] @relation("DefaultDepreciationCategory")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
}

model DepreciationRecord {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assetId  String
  asset    Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)

  periodStart        DateTime
  periodEnd          DateTime
  depreciationAmount Decimal  @db.Decimal(12, 2)
  accumulatedAmount  Decimal  @db.Decimal(12, 2)
  netBookValue       Decimal  @db.Decimal(12, 2)

  calculationType String // "SCHEDULED" | "MANUAL"
  calculatedAt    DateTime    @default(now())
  calculatedById  String?
  calculatedBy    TeamMember? @relation("DepreciationRecordCalculator", fields: [calculatedById], references: [id])
  notes           String?

  @@index([tenantId])
  @@index([assetId])
  @@index([periodEnd])
}

// ===== Company Document Management =====

model CompanyDocumentType {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String // e.g., "Commercial Registration", "Trade License"
  code        String // e.g., "CR", "TRADE_LICENSE" (for system use)
  category    String       @default("COMPANY") // COMPANY or VEHICLE
  description String?
  isActive    Boolean      @default(true)
  sortOrder   Int          @default(0)

  // Note: documents relation removed - CompanyDocument now uses documentTypeName string

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@index([tenantId])
}

model CompanyDocument {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Document Classification (simple string - no FK)
  documentTypeName String // e.g., "Commercial Registration", "Vehicle Insurance", custom name
  referenceNumber  String? // Document number/ID

  // Issuing Authority & Expiry
  issuedBy   String? // e.g., "Ministry of Commerce"
  expiryDate DateTime // Required - indexed for alerts

  // File Storage
  documentUrl String? // Supabase storage URL

  // Vehicle Linking (optional)
  assetId String?
  asset   Asset?  @relation(fields: [assetId], references: [id])

  // Status & Notes
  renewalCost Decimal? @db.Decimal(12, 2)
  notes       String?

  // Audit
  createdById String
  createdBy   TeamMember @relation("CompanyDocumentCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiryDate])
  @@index([assetId])
  @@index([tenantId])
  // SECURITY: Compound index for tenant-scoped expiry alerts (prevents full table scan)
  @@index([tenantId, expiryDate])
}

// ═══════════════════════════════════════════════════════════════════════════════
// AI CHATBOT - Conversation History
// ═══════════════════════════════════════════════════════════════════════════════

model ChatConversation {
  id        String    @id @default(cuid())
  tenantId  String
  memberId  String
  title     String? // Auto-generated from first message
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // For data retention - conversations auto-delete after this date

  tenant   Organization  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member   TeamMember    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([tenantId])
  @@index([memberId])
  @@index([createdAt])
  @@index([expiresAt])
}

model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String // "user" | "assistant"
  content        String   @db.Text
  functionCalls  Json? // Store function call details
  createdAt      DateTime @default(now())

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════════════════════
// AI CHAT USAGE TRACKING
// ═══════════════════════════════════════════════════════════════════════════════

model AIChatUsage {
  id        String  @id @default(cuid())
  tenantId  String
  memberId  String
  messageId String? // Optional link to ChatMessage

  // Token counts from OpenAI response
  promptTokens     Int
  completionTokens Int
  totalTokens      Int

  // Model used
  model String @default("gpt-4o-mini")

  // Calculated cost in USD (based on model pricing)
  costUsd Float

  createdAt DateTime @default(now())

  tenant Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member TeamMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@index([memberId])
}

// AI Chat Audit Log - For security monitoring and compliance
model AIChatAuditLog {
  id             String  @id @default(cuid())
  tenantId       String
  memberId       String
  conversationId String?

  // Privacy-friendly query tracking
  queryHash   String // SHA-256 hash of the query (for pattern detection without storing content)
  queryLength Int // Character count of original query

  // What was accessed
  functionsCalled Json // Array of function names called
  dataAccessed    Json // Summary of data types accessed

  // Performance & usage
  tokensUsed     Int
  responseTimeMs Int

  // Security metadata
  ipAddress String?
  userAgent String?

  // Risk assessment
  flagged     Boolean  @default(false)
  flagReasons String[] @default([])
  riskScore   Int      @default(0)

  createdAt DateTime @default(now())

  tenant Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member TeamMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([memberId, createdAt])
  @@index([flagged])
}

// ═══════════════════════════════════════════════════════════════════════════════
// WHATSAPP BUSINESS API INTEGRATION
// ═══════════════════════════════════════════════════════════════════════════════

// Per-tenant WhatsApp Business API credentials
model WhatsAppConfig {
  id                   String       @id @default(cuid())
  tenantId             String       @unique
  tenant               Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  phoneNumberId        String // Meta Phone Number ID
  businessAccountId    String // WhatsApp Business Account ID
  accessTokenEncrypted String // Encrypted permanent access token
  webhookVerifyToken   String // For webhook verification
  isActive             Boolean      @default(true)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@index([tenantId])
}

// Map members to their WhatsApp phone numbers
model WhatsAppUserPhone {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  memberId    String       @unique
  member      TeamMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  phoneNumber String // E.164 format: +974XXXXXXXX
  isVerified  Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([tenantId])
  @@index([phoneNumber])
}

// One-time action tokens for button callbacks
model WhatsAppActionToken {
  id         String       @id @default(cuid())
  tenantId   String
  tenant     Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  token      String       @unique // Encrypted token
  entityType String // 'LEAVE_REQUEST', 'PURCHASE_REQUEST', 'ASSET_REQUEST'
  entityId   String
  action     String // 'approve', 'reject'
  approverId String // User who should perform action
  used       Boolean      @default(false)
  usedAt     DateTime?
  expiresAt  DateTime // 60-minute expiry
  createdAt  DateTime     @default(now())

  @@index([tenantId])
  @@index([token])
  @@index([expiresAt])
}

// Message logging for debugging/audit
model WhatsAppMessageLog {
  id             String       @id @default(cuid())
  tenantId       String
  tenant         Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messageId      String? // Meta message ID
  recipientPhone String
  templateName   String
  status         String // 'sent', 'delivered', 'read', 'failed'
  errorMessage   String?
  entityType     String?
  entityId       String?
  configSource   String? // 'PLATFORM' or 'CUSTOM' - which config was used
  createdAt      DateTime     @default(now())

  @@index([tenantId])
  @@index([messageId])
}

// Platform-wide WhatsApp configuration (Super Admin only)
model PlatformWhatsAppConfig {
  id                   String   @id @default(cuid())
  phoneNumberId        String // Meta Phone Number ID
  businessAccountId    String // WhatsApp Business Account ID
  accessTokenEncrypted String // Encrypted permanent access token
  webhookVerifyToken   String // For webhook verification
  displayPhoneNumber   String? // Human-readable phone number for display
  businessName         String? // Business name for branding
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// ═══════════════════════════════════════════════════════════════════════════════
// PLATFORM FEEDBACK (Super Admin only - not tenant-scoped)
// ═══════════════════════════════════════════════════════════════════════════════

model Feedback {
  id String @id @default(cuid())

  // Submitter context (captured for reference, not tenant-scoped)
  organizationId   String? // Which org submitted (for context)
  organizationName String? // Denormalized for easy display
  submittedByEmail String // User email
  submittedByName  String? // User name

  // Feedback content
  type    String // 'BUG' | 'FEATURE_REQUEST'
  message String @db.Text

  // Auto-captured context
  pageUrl   String?
  userAgent String?

  // Attachment
  screenshotUrl String?

  // Status (managed by super-admin)
  status     String  @default("NEW") // NEW, REVIEWED, IN_PROGRESS, DONE, WONT_FIX
  adminNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([type])
  @@index([createdAt])
}
