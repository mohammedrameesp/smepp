// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  EMPLOYEE
  TEMP_STAFF
  MANAGER // First-level approver
  HR_MANAGER // HR approvals
  FINANCE_MANAGER // Finance/budget approvals
  DIRECTOR // High-value approvals
}

enum BillingCycle {
  MONTHLY
  YEARLY
  ONE_TIME
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum AssetStatus {
  IN_USE
  SPARE
  REPAIR
  DISPOSED
}

enum AcquisitionType {
  NEW_PURCHASE
  TRANSFERRED
}

enum SupplierStatus {
  PENDING
  APPROVED
  REJECTED
}

// Leave Management Enums
enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaveRequestType {
  FULL_DAY
  HALF_DAY_AM
  HALF_DAY_PM
}

enum LeaveCategory {
  STANDARD // Auto-initialized for all employees (Annual, Unpaid, Compassionate)
  MEDICAL // Medical-related, balance created on request (Sick Leave)
  PARENTAL // Gender-specific, balance created on request (Maternity, Paternity)
  RELIGIOUS // Religious leave, balance created on request (Hajj)
}

// ═══════════════════════════════════════════════════════════════════════════════
// NOTIFICATION SYSTEM ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum NotificationType {
  LEAVE_REQUEST_SUBMITTED
  LEAVE_REQUEST_APPROVED
  LEAVE_REQUEST_REJECTED
  LEAVE_REQUEST_CANCELLED
  ASSET_ASSIGNED
  ASSET_UNASSIGNED
  ASSET_REQUEST_SUBMITTED
  ASSET_REQUEST_APPROVED
  ASSET_REQUEST_REJECTED
  ASSET_RETURN_SUBMITTED
  ASSET_ASSIGNMENT_PENDING
  ASSET_ASSIGNMENT_ACCEPTED
  ASSET_ASSIGNMENT_DECLINED
  PURCHASE_REQUEST_SUBMITTED
  PURCHASE_REQUEST_APPROVED
  PURCHASE_REQUEST_REJECTED
  DOCUMENT_EXPIRY_WARNING
  GENERAL
  // Multi-level approval notifications
  APPROVAL_PENDING // Notify approver they have a pending approval
  APPROVAL_STEP_COMPLETED // Notify next approver/requester of step completion
  APPROVAL_FINAL_APPROVED // Notify requester of final approval
  APPROVAL_REJECTED // Notify requester of rejection at any level
}

// ═══════════════════════════════════════════════════════════════════════════════
// ASSET REQUEST WORKFLOW ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum AssetRequestType {
  EMPLOYEE_REQUEST // Employee requests a spare asset
  ADMIN_ASSIGNMENT // Admin assigns asset to user
  RETURN_REQUEST // User requests to return assigned asset
}

enum AssetRequestStatus {
  PENDING_ADMIN_APPROVAL // Employee request waiting for admin
  PENDING_USER_ACCEPTANCE // Admin assignment waiting for user
  PENDING_RETURN_APPROVAL // Return request waiting for admin
  ACCEPTED // User accepted assignment
  APPROVED // Admin approved request/return
  REJECTED // Admin rejected
  REJECTED_BY_USER // User declined assignment
  EXPIRED // Request timed out
  CANCELLED // Cancelled by requester
}

// ═══════════════════════════════════════════════════════════════════════════════
// MULTI-LEVEL APPROVAL WORKFLOW ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum ApprovalModule {
  LEAVE_REQUEST
  PURCHASE_REQUEST
  ASSET_REQUEST
}

enum ApprovalStepStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}

// ═══════════════════════════════════════════════════════════════════════════════
// MULTI-TENANT SAAS ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum SubscriptionTier {
  FREE
  PLUS
}

enum OrgRole {
  OWNER // Full control, billing access
  ADMIN // Manage users, settings
  MANAGER // Approve requests, view reports
  MEMBER // Basic access
}

enum WhatsAppSource {
  NONE // WhatsApp disabled
  PLATFORM // Use platform-wide config
  CUSTOM // Use tenant's own config
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String    @unique
  emailVerified   DateTime?
  image           String?
  passwordHash    String? // For email/password auth
  role            Role      @default(EMPLOYEE)
  isSystemAccount Boolean   @default(false) // For shared assets and system users
  isSuperAdmin    Boolean   @default(false) // Platform-level admin (can manage all orgs)
  isEmployee      Boolean   @default(true) // Is this user an employee (appears in HR/payroll)?
  canLogin        Boolean   @default(true) // Can this user authenticate to the system?
  isOnWps         Boolean   @default(true) // Is this employee on WPS (Wage Protection System)?

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Session security - used to invalidate sessions on password change
  passwordChangedAt DateTime? // Set when password is changed, checked against session iat

  // Account lockout (brute-force protection)
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime? // Account locked until this time

  // Initial password setup (for new employees)
  setupToken       String?   @unique
  setupTokenExpiry DateTime?

  // Soft-delete fields
  isDeleted           Boolean   @default(false)
  deletedAt           DateTime?
  scheduledDeletionAt DateTime? // 7 days after deletedAt for permanent deletion
  deletedByUserId     String?

  // Two-Factor Authentication (for super admins)
  twoFactorSecret      String? // Encrypted TOTP secret
  twoFactorEnabled     Boolean   @default(false)
  twoFactorBackupCodes String[] // Hashed backup codes
  pending2FATokenJti   String? // Current pending 2FA token's unique ID (prevents replay)
  twoFactorVerifiedAt  DateTime? // Last 2FA verification timestamp (for sensitive ops re-verification)

  accounts                     Account[]
  sessions                     Session[]
  assets                       Asset[]
  subscriptions                Subscription[]
  activityLogs                 ActivityLog[]
  assetHistoryFrom             AssetHistory[]        @relation("AssetHistoryFromUser")
  assetHistoryTo               AssetHistory[]        @relation("AssetHistoryToUser")
  assetHistoryPerformed        AssetHistory[]        @relation("AssetHistoryPerformer")
  subscriptionHistoryPerformed SubscriptionHistory[] @relation("SubscriptionHistoryPerformer")
  subscriptionHistoryOldUser   SubscriptionHistory[] @relation("SubscriptionHistoryOldUser")
  subscriptionHistoryNewUser   SubscriptionHistory[] @relation("SubscriptionHistoryNewUser")
  approvedSuppliers            Supplier[]            @relation("SupplierApprover")
  supplierEngagements          SupplierEngagement[]
  systemSettingsUpdated        SystemSettings[]      @relation("SystemSettingsUpdater")
  hrProfile                    HRProfile?

  // Purchase Request relations
  purchaseRequests         PurchaseRequest[]        @relation("PurchaseRequester")
  reviewedPurchaseRequests PurchaseRequest[]        @relation("PurchaseReviewer")
  purchaseRequestHistory   PurchaseRequestHistory[] @relation("PurchaseRequestHistoryPerformer")

  // Leave Management relations
  leaveRequests         LeaveRequest[]        @relation("LeaveRequests")
  leaveApprovals        LeaveRequest[]        @relation("LeaveApprovals")
  leaveRequestsCreated  LeaveRequest[]        @relation("LeaveRequestCreator")
  leaveBalances         LeaveBalance[]
  leaveHistoryPerformed LeaveRequestHistory[] @relation("LeaveHistoryPerformer")

  // Payroll Management relations
  salaryStructure         SalaryStructure?
  salaryHistoryPerformed  SalaryStructureHistory[] @relation("SalaryHistoryPerformer")
  payslips                Payslip[]
  submittedPayrolls       PayrollRun[]             @relation("PayrollSubmitter")
  approvedPayrolls        PayrollRun[]             @relation("PayrollApprover")
  processedPayrolls       PayrollRun[]             @relation("PayrollProcessor")
  paidPayrolls            PayrollRun[]             @relation("PayrollPayer")
  createdPayrolls         PayrollRun[]             @relation("PayrollCreator")
  payrollHistoryPerformed PayrollHistory[]         @relation("PayrollHistoryPerformer")
  employeeLoans           EmployeeLoan[]
  approvedLoans           EmployeeLoan[]           @relation("LoanApprover")
  createdLoans            EmployeeLoan[]           @relation("LoanCreator")
  recordedRepayments      LoanRepayment[]          @relation("RepaymentRecorder")

  // Asset Request relations
  assetRequests                AssetRequest[]        @relation("AssetRequestUser")
  assetRequestsAssigned        AssetRequest[]        @relation("AssetRequestAssigner")
  assetRequestsProcessed       AssetRequest[]        @relation("AssetRequestProcessor")
  assetRequestHistoryPerformed AssetRequestHistory[] @relation("AssetRequestHistoryPerformer")

  // Company Document relations
  companyDocumentsCreated CompanyDocument[] @relation("CompanyDocumentCreator")

  // Notification relations
  notifications Notification[] @relation("UserNotifications")

  // Multi-level Approval relations
  approvalSteps     ApprovalStep[]       @relation("ApprovalStepApprover")
  delegationsAsFrom ApproverDelegation[] @relation("DelegatorUser")
  delegationsAsTo   ApproverDelegation[] @relation("DelegateeUser")

  // Organization membership (multi-tenant)
  organizationMemberships OrganizationUser[]

  // Depreciation relations
  depreciationRecords DepreciationRecord[] @relation("DepreciationRecordCalculator")

  // Chat relations
  chatConversations ChatConversation[]
  aiChatUsage       AIChatUsage[]
  aiChatAuditLogs   AIChatAuditLog[]

  // WhatsApp integration
  whatsAppPhone WhatsAppUserPhone?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Index for scheduled deletion cron job
  @@index([scheduledDeletionAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ═══════════════════════════════════════════════════════════════════════════════
// MULTI-TENANT ORGANIZATION MODELS
// ═══════════════════════════════════════════════════════════════════════════════

model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique // URL-friendly identifier (e.g., "acme-corp")

  // Branding
  logoUrl            String?
  primaryColor       String  @default("#1E40AF") // Deep Blue - brand primary
  secondaryColor     String? // Accent color
  loginBackgroundUrl String? // Background image for login page
  welcomeTitle       String? // Custom welcome title (e.g., "Welcome to Acme")
  welcomeSubtitle    String? // Custom welcome subtitle/tagline

  // Settings
  timezone String @default("Asia/Qatar") // Hardcoded to Qatar timezone (UTC+3)
  currency String @default("QAR") // Primary currency always QAR

  // Reference Code Prefix (auto-generated from org name, customizable by admin)
  // Used for employee IDs, asset tags, purchase requests, etc.
  codePrefix String @default("ORG")

  // Custom code format patterns for different entity types
  // JSON structure: { "employees": "{PREFIX}-{YYYY}-{SEQ:3}", "assets": "{PREFIX}-{TYPE}-{YYMM}-{SEQ:3}", ... }
  codeFormats Json @default("{}")

  // Organization metadata (for super-admin tracking)
  industry      String? // Technology, Retail, Healthcare, etc.
  companySize   String? // 1-10, 11-50, 51-200, 201-500, 500+
  internalNotes String? // Super-admin only notes (not visible to org users)

  // Module configuration (client chooses which to enable)
  enabledModules String[] @default(["assets", "subscriptions", "suppliers"])

  // AI Chat feature (super-admin controlled)
  aiChatEnabled        Boolean @default(false)
  aiTokenBudgetMonthly Int? // Custom monthly AI token limit (null = use tier default)

  // Additional currencies beyond QAR (e.g., ["USD", "EUR"])
  additionalCurrencies String[] @default([])

  // Onboarding tracking
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?
  onboardingStep        Int       @default(0) // Current step in wizard (0-5)

  // Subscription & Billing
  subscriptionTier SubscriptionTier @default(FREE)
  stripeCustomerId String?          @unique
  stripePriceId    String? // Current subscription price
  stripeSubEnd     DateTime? // Subscription end date

  // Usage Limits (can be overridden from tier defaults)
  maxUsers  Int @default(5)
  maxAssets Int @default(50)

  // ═══════════════════════════════════════════════════════════════════════════════
  // AUTHENTICATION CONFIGURATION (Super Admin only)
  // ═══════════════════════════════════════════════════════════════════════════════

  // Allowed auth methods: ["credentials", "google", "azure-ad"]
  // Empty array = all platform-enabled methods allowed (default)
  allowedAuthMethods String[] @default([])

  // Email domain restrictions (e.g., ["company.com", "subsidiary.com"])
  // Empty array = any email domain allowed (default)
  allowedEmailDomains String[] @default([])

  // Whether to enforce domain restriction (block logins from other domains)
  enforceDomainRestriction Boolean @default(false)

  // Custom OAuth credentials (Enterprise feature - encrypted)
  // These override platform-level OAuth apps when provided
  customGoogleClientId     String?
  customGoogleClientSecret String? // Encrypted at rest
  customAzureClientId      String?
  customAzureClientSecret  String? // Encrypted at rest
  customAzureTenantId      String? // For Azure AD directory restriction

  // Core Relations
  members       OrganizationUser[]
  invitations   OrganizationInvitation[]
  setupProgress OrganizationSetupProgress?

  // Tenant-scoped data relations
  assets                Asset[]
  assetHistories        AssetHistory[]
  subscriptions         Subscription[]
  activityLogs          ActivityLog[]
  notifications         Notification[]
  approvalPolicies      ApprovalPolicy[]
  approvalSteps         ApprovalStep[]
  approverDelegations   ApproverDelegation[]
  maintenanceRecords    MaintenanceRecord[]
  suppliers             Supplier[]
  supplierEngagements   SupplierEngagement[]
  systemSettings        SystemSettings[]
  hrProfiles            HRProfile[]
  profileChangeRequests ProfileChangeRequest[]
  purchaseRequests      PurchaseRequest[]
  leaveTypes            LeaveType[]
  leaveBalances         LeaveBalance[]
  leaveRequests         LeaveRequest[]
  salaryStructures      SalaryStructure[]
  payrollRuns           PayrollRun[]
  payslips              Payslip[]
  employeeLoans         EmployeeLoan[]
  assetRequests         AssetRequest[]
  companyDocumentTypes  CompanyDocumentType[]
  companyDocuments      CompanyDocument[]
  depreciationRecords   DepreciationRecord[]
  chatConversations     ChatConversation[]
  aiChatUsage           AIChatUsage[]
  aiChatAuditLogs       AIChatAuditLog[]

  // Access Control
  rolePermissions RolePermission[]

  // WhatsApp integration
  whatsAppSource          WhatsAppSource        @default(NONE) // NONE, PLATFORM, or CUSTOM
  whatsAppPlatformEnabled Boolean               @default(false) // Super-admin controlled: can tenant use platform WhatsApp?
  whatsAppConfig          WhatsAppConfig?
  whatsAppUserPhones      WhatsAppUserPhone[]
  whatsAppActionTokens    WhatsAppActionToken[]
  whatsAppMessageLogs     WhatsAppMessageLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([stripeCustomerId])
}

model OrganizationUser {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  role    OrgRole @default(MEMBER)
  isOwner Boolean @default(false) // Original creator

  joinedAt DateTime @default(now())

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([organizationId])
}

model OrganizationInvitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  email String
  name  String? // Optional name for the invitee (pre-filled in signup)
  role  OrgRole @default(MEMBER)
  token String  @unique @default(cuid())

  invitedById String? // User who sent the invitation

  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  @@unique([organizationId, email])
  @@index([token])
  @@index([email])
}

// Custom role permissions per organization
// OWNER and ADMIN have all permissions by default (not stored)
// MANAGER and MEMBER get custom permissions stored here
model RolePermission {
  id         String       @id @default(cuid())
  tenantId   String
  tenant     Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role       OrgRole // MANAGER or MEMBER (OWNER/ADMIN have all by default)
  permission String // e.g., "assets:view", "payroll:run"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, role, permission])
  @@index([tenantId])
  @@index([tenantId, role])
}

model OrganizationSetupProgress {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Checklist items
  profileComplete        Boolean @default(false) // Org name and basic info configured
  logoUploaded           Boolean @default(false) // Logo has been uploaded
  brandingConfigured     Boolean @default(false) // Primary color customized
  firstAssetAdded        Boolean @default(false) // At least one asset created
  firstTeamMemberInvited Boolean @default(false) // At least one invitation sent
  firstEmployeeAdded     Boolean @default(false) // At least one HR profile created

  // Allow users to dismiss the checklist
  isDismissed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

// ═══════════════════════════════════════════════════════════════════════════════
// IMPERSONATION TOKEN REVOCATION (Super Admin Security)
// ═══════════════════════════════════════════════════════════════════════════════

model RevokedImpersonationToken {
  id        String   @id @default(cuid())
  jti       String   @unique // JWT ID from the impersonation token
  revokedAt DateTime @default(now())
  revokedBy String // Super admin ID who revoked
  reason    String? // Optional reason for revocation

  // Token metadata (for audit purposes)
  superAdminId     String // Original token issuer
  organizationId   String // Target organization
  organizationSlug String
  issuedAt         DateTime // When the original token was issued
  expiresAt        DateTime // When the original token would have expired

  @@index([jti])
  @@index([superAdminId])
  @@index([expiresAt]) // For cleanup of expired entries
}

// Project model removed - projects are now handled separately by accreditation module

model Asset {
  id              String          @id @default(cuid())
  tenantId        String
  tenant          Organization    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assetTag        String? // #1 Asset ID/Tag
  type            String // #2 Asset Type (Laptop, Mouse, Monitor, etc.)
  category        String? // #3 Category/Department (IT, Marketing, Engineering, etc.)
  brand           String? // #4 Brand/Manufacturer (Apple, Dell, HP, etc.)
  model           String // #5 Model/Version (MacBook Pro 16", Dell XPS 15, etc.)
  serial          String? // #6 Serial Number
  configuration   String? // #7 Configuration/Specs (16GB RAM, 512GB SSD, etc.)
  purchaseDate    DateTime? // #8 Purchase Date
  warrantyExpiry  DateTime? // #9 Warranty Expiry
  supplier        String? // #10 Supplier/Vendor (where purchased from)
  invoiceNumber   String? // #12 Invoice/PO Number
  assignedUserId  String? // #13 Assigned To/User
  assignedUser    User?           @relation(fields: [assignedUserId], references: [id])
  assignmentDate  DateTime? // When the asset was assigned to current user
  status          AssetStatus     @default(IN_USE) // #14 Status/Condition
  acquisitionType AcquisitionType @default(NEW_PURCHASE) // #15 Asset Movement (New/Transferred)
  transferNotes   String? // Notes for transferred assets
  price           Decimal? // #16 Cost/Value
  priceCurrency   String?         @default("QAR")
  priceQAR        Decimal?

  // Additional fields
  notes    String? // General notes/remarks about the asset
  location String? // Physical location of the asset (Office, Building, Room, etc.)
  isShared Boolean @default(false) // Shared/common resource (e.g., printer, conference room equipment)

  // Depreciation fields
  depreciationCategoryId  String?
  depreciationCategory    DepreciationCategory? @relation(fields: [depreciationCategoryId], references: [id])
  salvageValue            Decimal?              @default(0) @db.Decimal(12, 2)
  customUsefulLifeMonths  Int? // Override category default if needed
  depreciationStartDate   DateTime? // Defaults to purchaseDate
  accumulatedDepreciation Decimal?              @default(0) @db.Decimal(12, 2)
  netBookValue            Decimal?              @db.Decimal(12, 2)
  lastDepreciationDate    DateTime?
  isFullyDepreciated      Boolean               @default(false)

  // Relations & Metadata
  history             AssetHistory[]
  maintenanceRecords  MaintenanceRecord[]
  assetRequests       AssetRequest[]
  companyDocuments    CompanyDocument[] // Vehicle documents (insurance, istimara)
  depreciationRecords DepreciationRecord[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@unique([tenantId, assetTag])
  @@index([warrantyExpiry])
  @@index([brand])
  @@index([model])
  @@index([type])
  @@index([serial])
  @@index([assetTag])
  @@index([tenantId])
}

enum AssetHistoryAction {
  ASSIGNED
  UNASSIGNED
  STATUS_CHANGED
  LOCATION_CHANGED
  CREATED
  UPDATED
}

model AssetHistory {
  id             String             @id @default(cuid())
  tenantId       String
  tenant         Organization       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assetId        String
  asset          Asset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  action         AssetHistoryAction
  fromUserId     String?
  fromUser       User?              @relation("AssetHistoryFromUser", fields: [fromUserId], references: [id])
  toUserId       String?
  toUser         User?              @relation("AssetHistoryToUser", fields: [toUserId], references: [id])
  fromStatus     AssetStatus?
  toStatus       AssetStatus?
  fromLocation   String?
  toLocation     String?
  notes          String?
  performedBy    String?
  performer      User?              @relation("AssetHistoryPerformer", fields: [performedBy], references: [id])
  assignmentDate DateTime? // When asset was assigned (for ASSIGNED action)
  returnDate     DateTime? // When asset was returned (for UNASSIGNED action)
  createdAt      DateTime           @default(now())

  @@index([assetId])
  @@index([createdAt])
  @@index([toUserId])
  @@index([tenantId])
}

model Subscription {
  id                    String                @id @default(cuid())
  tenantId              String
  tenant                Organization          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  serviceName           String
  category              String?
  accountId             String?
  purchaseDate          DateTime?
  renewalDate           DateTime?
  billingCycle          BillingCycle
  costPerCycle          Decimal?
  costCurrency          String?               @default("QAR")
  costQAR               Decimal?
  vendor                String?
  status                SubscriptionStatus    @default(ACTIVE)
  assignedUserId        String?
  assignedUser          User?                 @relation(fields: [assignedUserId], references: [id])
  autoRenew             Boolean               @default(true)
  paymentMethod         String?
  notes                 String?
  lastActiveRenewalDate DateTime? // Track last renewal before cancel
  cancelledAt           DateTime? // When it was cancelled
  reactivatedAt         DateTime? // When it was last reactivated
  history               SubscriptionHistory[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  @@index([renewalDate])
  @@index([status])
  @@index([category])
  @@index([serviceName])
  @@index([vendor])
  @@index([accountId])
  @@index([tenantId])
}

enum SubscriptionHistoryAction {
  CREATED
  REACTIVATED
  CANCELLED
  RENEWED
  REASSIGNED
}

model SubscriptionHistory {
  id               String                    @id @default(cuid())
  subscriptionId   String
  subscription     Subscription              @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  action           SubscriptionHistoryAction
  oldStatus        SubscriptionStatus?
  newStatus        SubscriptionStatus?
  oldRenewalDate   DateTime?
  newRenewalDate   DateTime?
  reactivationDate DateTime? // Date when service was reactivated
  assignmentDate   DateTime? // Date when user was assigned/reassigned
  oldUserId        String? // Previous assigned user
  newUserId        String? // New assigned user
  oldUser          User?                     @relation("SubscriptionHistoryOldUser", fields: [oldUserId], references: [id])
  newUser          User?                     @relation("SubscriptionHistoryNewUser", fields: [newUserId], references: [id])
  notes            String?
  performedBy      String?
  performer        User?                     @relation("SubscriptionHistoryPerformer", fields: [performedBy], references: [id])
  createdAt        DateTime                  @default(now())

  @@index([subscriptionId])
  @@index([createdAt])
}

model ActivityLog {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actorUserId String?
  actorUser   User?        @relation(fields: [actorUserId], references: [id])
  action      String
  entityType  String?
  entityId    String?
  payload     Json?
  at          DateTime     @default(now())

  @@index([actorUserId])
  @@index([at])
  @@index([tenantId])
}

// ═══════════════════════════════════════════════════════════════════════════════
// NOTIFICATION SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════

model Notification {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recipientId String
  recipient   User         @relation("UserNotifications", fields: [recipientId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String
  link    String? // URL to navigate when clicked

  entityType String? // Related entity type (e.g., "LeaveRequest", "Asset")
  entityId   String? // Related entity ID

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([recipientId])
  @@index([recipientId, isRead])
  @@index([createdAt])
  @@index([tenantId])
}

// ═══════════════════════════════════════════════════════════════════════════════
// MULTI-LEVEL APPROVAL WORKFLOW MODELS
// ═══════════════════════════════════════════════════════════════════════════════

model ApprovalPolicy {
  id        String         @id @default(cuid())
  tenantId  String
  tenant    Organization   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  module    ApprovalModule
  isActive  Boolean        @default(true)
  minAmount Decimal?       @db.Decimal(12, 2) // For purchase/asset thresholds
  maxAmount Decimal?       @db.Decimal(12, 2)
  minDays   Int? // For leave request thresholds
  maxDays   Int?
  priority  Int            @default(0) // Higher = checked first

  levels ApprovalLevel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([module, isActive])
  @@index([priority])
  @@index([tenantId])
}

model ApprovalLevel {
  id           String         @id @default(cuid())
  policyId     String
  policy       ApprovalPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  levelOrder   Int // 1, 2, 3... defines approval sequence
  approverRole Role // MANAGER, HR_MANAGER, FINANCE_MANAGER, DIRECTOR

  @@unique([policyId, levelOrder])
  @@index([policyId])
}

model ApprovalStep {
  id           String         @id @default(cuid())
  tenantId     String
  tenant       Organization   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entityType   ApprovalModule // Which module (LEAVE_REQUEST, PURCHASE_REQUEST, ASSET_REQUEST)
  entityId     String // The ID of the request being approved
  levelOrder   Int // Which level in the chain
  requiredRole Role // Role required to approve this step

  approverId String? // User who took action (null if pending)
  approver   User?   @relation("ApprovalStepApprover", fields: [approverId], references: [id])

  status   ApprovalStepStatus @default(PENDING)
  actionAt DateTime? // When action was taken
  notes    String? // Approver notes

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([requiredRole, status])
  @@index([approverId])
  @@index([tenantId])
  @@index([tenantId, status, requiredRole])
  @@index([tenantId, approverId, status])
}

model ApproverDelegation {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  delegatorId String // User who is delegating
  delegator   User         @relation("DelegatorUser", fields: [delegatorId], references: [id])
  delegateeId String // User receiving delegation
  delegatee   User         @relation("DelegateeUser", fields: [delegateeId], references: [id])

  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)
  reason    String? // e.g., "On leave"

  createdAt DateTime @default(now())

  @@index([delegatorId, isActive])
  @@index([delegateeId, isActive])
  @@index([startDate, endDate])
  @@index([tenantId])
}

model MaintenanceRecord {
  id              String       @id @default(cuid())
  tenantId        String
  tenant          Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assetId         String
  asset           Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)
  maintenanceDate DateTime
  notes           String?
  performedBy     String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([assetId])
  @@index([maintenanceDate])
  @@index([tenantId])
}

model Supplier {
  id                     String               @id @default(cuid())
  tenantId               String
  tenant                 Organization         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  suppCode               String? // Auto-generated SUPP-XXXX on approval
  name                   String
  category               String // Material category
  address                String?
  city                   String?
  country                String?
  website                String?
  establishmentYear      Int?
  primaryContactName     String?
  primaryContactTitle    String?
  primaryContactEmail    String?
  primaryContactMobile   String?
  secondaryContactName   String?
  secondaryContactTitle  String?
  secondaryContactEmail  String?
  secondaryContactMobile String?
  paymentTerms           String?
  additionalInfo         String? // Additional information (portfolio, certifications, etc.)
  status                 SupplierStatus       @default(PENDING)
  rejectionReason        String?
  approvedAt             DateTime?
  approvedById           String?
  approvedBy             User?                @relation("SupplierApprover", fields: [approvedById], references: [id])
  engagements            SupplierEngagement[]
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  @@unique([tenantId, suppCode])
  @@index([status])
  @@index([suppCode])
  @@index([createdAt])
  @@index([name])
  @@index([category])
  @@index([tenantId])
}

model SupplierEngagement {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplierId  String
  supplier    Supplier     @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  date        DateTime
  notes       String
  rating      Int? // 1-5 star rating (optional)
  createdById String
  createdBy   User         @relation(fields: [createdById], references: [id])
  createdAt   DateTime     @default(now())

  @@index([supplierId])
  @@index([date])
  @@index([tenantId])
}

model AppSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model SystemSettings {
  id        String       @id @default(cuid())
  tenantId  String
  tenant    Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key       String // Removed @unique - now part of composite unique constraint
  value     String
  updatedBy String?
  updater   User?        @relation("SystemSettingsUpdater", fields: [updatedBy], references: [id])
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([tenantId, key]) // SECURITY: Each tenant can have their own settings
  @@index([key])
  @@index([tenantId])
}

model HRProfile {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId   String       @unique
  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal Information
  dateOfBirth   DateTime?
  gender        String? // Male/Female/Other
  maritalStatus String? // Single/Married/Divorced/Widowed
  nationality   String?

  // Contact Information
  qatarMobile        String? // 8-digit number (prefix +974 hardcoded in UI)
  otherMobileCode    String? @default("+961") // Country code (Lebanon default)
  otherMobileNumber  String?
  personalEmail      String?
  // workEmail from User.email (read-only)
  qatarZone          String?
  qatarStreet        String?
  qatarBuilding      String?
  qatarUnit          String?
  homeCountryAddress String? // textarea

  // Emergency Contacts - Local (Qatar)
  localEmergencyName      String?
  localEmergencyRelation  String?
  localEmergencyPhoneCode String? @default("+974")
  localEmergencyPhone     String?

  // Emergency Contacts - Home Country
  homeEmergencyName      String?
  homeEmergencyRelation  String?
  homeEmergencyPhoneCode String? @default("+961")
  homeEmergencyPhone     String?

  // Identification & Legal
  qidNumber        String?
  qidExpiry        DateTime?
  passportNumber   String?
  passportExpiry   DateTime?
  // passportCountry removed - QID serves as unique identifier
  // healthCardNumber removed - QID serves as unique identifier
  healthCardExpiry DateTime?
  sponsorshipType  String? // Company/Family/Work Permit

  // Employment Information
  employeeId              String? // Admin-only editable
  designation             String?
  dateOfJoining           DateTime?
  terminationDate         DateTime? // Date employee's service ended (for gratuity/service calculations)
  terminationReason       String? // Optional reason for termination
  hajjLeaveTaken          Boolean   @default(false) // Qatar law: Hajj leave can only be taken once during employment
  bypassNoticeRequirement Boolean   @default(false) // Admin override: bypass advance notice requirements for leave requests

  // Bank & Payroll
  bankName String?
  iban     String?

  // Education
  highestQualification String?
  specialization       String?
  institutionName      String?
  graduationYear       Int?

  // Documents (Supabase storage URLs)
  qidUrl          String?
  passportCopyUrl String?
  photoUrl        String?
  contractCopyUrl String?
  contractExpiry  DateTime? // Employment contract / work permit expiry

  // Additional Info
  hasDrivingLicense    Boolean   @default(false)
  // licenseNumber removed - QID serves as unique identifier
  licenseExpiry        DateTime?
  languagesKnown       String? // JSON array stored as string
  skillsCertifications String? // JSON array stored as string

  // Onboarding tracking
  onboardingStep     Int     @default(0) // Current step in wizard (0-7)
  onboardingComplete Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  changeRequests ProfileChangeRequest[]

  @@index([qidNumber])
  @@index([passportNumber])
  @@index([employeeId])
  @@index([tenantId])
  // SECURITY: Indexes for document expiry cron jobs (prevents full table scans)
  @@index([qidExpiry])
  @@index([passportExpiry])
  @@index([healthCardExpiry])
  @@index([contractExpiry])
  @@index([licenseExpiry])
  // Compound index for tenant-scoped expiry queries
  @@index([tenantId, qidExpiry])
  @@index([tenantId, passportExpiry])
  @@index([tenantId, contractExpiry])
  // Service date indexes for gratuity/anniversary queries
  @@index([tenantId, dateOfJoining])
  @@index([tenantId, terminationDate])
}

enum ProfileChangeRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// ===== Purchase Request Module Enums =====

enum PurchaseRequestStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  COMPLETED
}

enum PurchaseRequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PurchaseType {
  HARDWARE
  SOFTWARE_SUBSCRIPTION
  SERVICES
  OFFICE_SUPPLIES
  MARKETING
  TRAVEL
  TRAINING
  OTHER
}

enum CostType {
  OPERATING_COST
  PROJECT_COST
}

enum PaymentMode {
  BANK_TRANSFER
  CREDIT_CARD
  CASH
  CHEQUE
  INTERNAL_TRANSFER
}

model ProfileChangeRequest {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  hrProfileId String
  hrProfile   HRProfile    @relation(fields: [hrProfileId], references: [id], onDelete: Cascade)

  // Request details
  description String // What changes the user is requesting
  status      ProfileChangeRequestStatus @default(PENDING)

  // Resolution
  resolvedById  String?
  resolvedAt    DateTime?
  resolverNotes String? // Admin notes when resolving

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hrProfileId])
  @@index([status])
  @@index([createdAt])
  @@index([tenantId])
}

// ===== Purchase Request Module Models =====

model PurchaseRequest {
  id              String                  @id @default(cuid())
  tenantId        String
  tenant          Organization            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  referenceNumber String // {PREFIX}-PR-YYMM-XXXX (tenant-scoped unique)
  requestDate     DateTime                @default(now())
  status          PurchaseRequestStatus   @default(PENDING)
  priority        PurchaseRequestPriority @default(MEDIUM)

  // Requester info (auto-populated from logged-in user)
  requesterId String
  requester   User   @relation("PurchaseRequester", fields: [requesterId], references: [id])

  // Request details
  title         String
  description   String?
  justification String? // Business justification
  neededByDate  DateTime? // When items are needed

  // Purchase Type & Cost Details (from prototype)
  purchaseType PurchaseType @default(OTHER)
  costType     CostType     @default(OPERATING_COST)
  projectName  String? // Required when costType is PROJECT_COST
  paymentMode  PaymentMode  @default(BANK_TRANSFER)

  // Vendor Details
  vendorName    String?
  vendorContact String?
  vendorEmail   String?

  // Additional Notes
  additionalNotes String?

  // Totals
  totalAmount        Decimal  @db.Decimal(12, 2)
  currency           String   @default("QAR")
  totalAmountQAR     Decimal? @db.Decimal(12, 2)
  totalOneTime       Decimal? @db.Decimal(12, 2) // One-time costs total
  totalMonthly       Decimal? @db.Decimal(12, 2) // Monthly recurring total
  totalContractValue Decimal? @db.Decimal(12, 2) // Total contract value

  // Approval workflow
  reviewedById String?
  reviewedBy   User?     @relation("PurchaseReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  reviewNotes  String?

  // Completion
  completedAt     DateTime?
  completionNotes String?

  // Relations
  items   PurchaseRequestItem[]
  history PurchaseRequestHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, referenceNumber])
  @@index([requesterId])
  @@index([status])
  @@index([referenceNumber])
  @@index([createdAt])
  @@index([purchaseType])
  @@index([costType])
  @@index([tenantId])
}

model PurchaseRequestItem {
  id                String          @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  itemNumber    Int // Line item number (1, 2, 3...)
  description   String
  quantity      Int      @default(1)
  unitPrice     Decimal  @db.Decimal(12, 2)
  currency      String   @default("QAR")
  unitPriceQAR  Decimal? @db.Decimal(12, 2)
  totalPrice    Decimal  @db.Decimal(12, 2) // quantity * unitPrice
  totalPriceQAR Decimal? @db.Decimal(12, 2)

  // Subscription/recurring fields (for SOFTWARE_SUBSCRIPTION type)
  billingCycle   BillingCycle @default(ONE_TIME) // ONE_TIME, MONTHLY, YEARLY
  durationMonths Int? // Duration in months (for monthly billing)
  amountPerCycle Decimal?     @db.Decimal(12, 2) // Recurring cost per cycle

  // Product details
  productUrl String? // Product link URL

  category String? // IT Equipment, Office Supplies, etc.
  supplier String? // Preferred supplier
  notes    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([purchaseRequestId])
  @@index([billingCycle])
}

model PurchaseRequestHistory {
  id                String          @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  action         String // CREATED, STATUS_CHANGED, UPDATED, ITEM_ADDED, ITEM_REMOVED
  previousStatus PurchaseRequestStatus?
  newStatus      PurchaseRequestStatus?

  performedById String
  performedBy   User   @relation("PurchaseRequestHistoryPerformer", fields: [performedById], references: [id])

  details String? // JSON or text description of changes

  createdAt DateTime @default(now())

  @@index([purchaseRequestId])
  @@index([performedById])
  @@index([createdAt])
}

// ===== Leave Management Module Models =====

model LeaveType {
  id                  String       @id @default(cuid())
  tenantId            String
  tenant              Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name                String // Annual, Sick, Maternity, Hajj, Paternity, Unpaid, Compassionate
  description         String?
  color               String       @default("#3B82F6") // For calendar display
  defaultDays         Int          @default(0) // Default annual entitlement
  requiresApproval    Boolean      @default(true)
  requiresDocument    Boolean      @default(false) // Medical certificate etc.
  isPaid              Boolean      @default(true)
  isActive            Boolean      @default(true)
  maxConsecutiveDays  Int? // Max consecutive days allowed
  minNoticeDays       Int          @default(0) // Advance notice required
  allowCarryForward   Boolean      @default(false)
  maxCarryForwardDays Int?

  // Qatar Labor Law Fields
  minimumServiceMonths    Int           @default(0) // Minimum months of service required (e.g., 3 for sick, 12 for annual/Hajj)
  isOnceInEmployment      Boolean       @default(false) // Can only use once (Hajj leave)
  serviceBasedEntitlement Json? // Service-based days: {"12": 21, "60": 28} (months: days) for annual leave
  payTiers                Json? // For sick leave: [{"days": 14, "payPercent": 100}, {"days": 28, "payPercent": 50}, {"days": 42, "payPercent": 0}]
  category                LeaveCategory @default(STANDARD) // STANDARD auto-init, others admin-assigned
  genderRestriction       String? // "MALE", "FEMALE", or null for any
  accrualBased            Boolean       @default(false) // If true, entitlement accrues monthly

  leaveRequests LeaveRequest[]
  leaveBalances LeaveBalance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([isActive])
  @@index([category])
  @@index([tenantId])
}

model LeaveBalance {
  id              String       @id @default(cuid())
  tenantId        String
  tenant          Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaveTypeId     String
  leaveType       LeaveType    @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)
  year            Int // Year for balance
  entitlement     Decimal      @default(0) // Total days entitled
  used            Decimal      @default(0) // Days used
  pending         Decimal      @default(0) // Days in pending requests
  carriedForward  Decimal      @default(0) // From previous year
  adjustment      Decimal      @default(0) // Manual adjustments (+/-)
  adjustmentNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, userId, leaveTypeId, year])
  @@index([userId])
  @@index([leaveTypeId])
  @@index([year])
  @@index([tenantId])
}

model LeaveRequest {
  id            String           @id @default(cuid())
  tenantId      String
  tenant        Organization     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requestNumber String // {PREFIX}-LR-XXXXX (tenant-scoped unique)
  userId        String
  user          User             @relation("LeaveRequests", fields: [userId], references: [id], onDelete: Cascade)
  leaveTypeId   String
  leaveType     LeaveType        @relation(fields: [leaveTypeId], references: [id])
  startDate     DateTime
  endDate       DateTime
  requestType   LeaveRequestType @default(FULL_DAY)
  totalDays     Decimal // Calculated working days
  reason        String?
  documentUrl   String? // Supporting document

  status LeaveStatus @default(PENDING)

  // Approval
  approverId    String?
  approver      User?     @relation("LeaveApprovals", fields: [approverId], references: [id])
  approvedAt    DateTime?
  approverNotes String?

  // Rejection
  rejectedAt      DateTime?
  rejectionReason String?

  // Cancellation
  cancelledAt        DateTime?
  cancellationReason String?

  // On behalf of: track who submitted if different from user
  createdById String?
  createdBy   User?   @relation("LeaveRequestCreator", fields: [createdById], references: [id])

  // Emergency contact during leave
  emergencyContact String?
  emergencyPhone   String?

  history LeaveRequestHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, requestNumber])
  @@index([userId])
  @@index([leaveTypeId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, userId])
  @@index([tenantId, startDate, status])
}

model LeaveRequestHistory {
  id             String       @id @default(cuid())
  leaveRequestId String
  leaveRequest   LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)

  action    String // CREATED, SUBMITTED, APPROVED, REJECTED, CANCELLED, UPDATED
  oldStatus LeaveStatus?
  newStatus LeaveStatus?
  changes   Json?
  notes     String?

  performedById String
  performedBy   User   @relation("LeaveHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([leaveRequestId])
  @@index([createdAt])
}

// ===== Payroll Management Module Enums =====

enum PayrollStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PROCESSED
  PAID
  CANCELLED
}

enum LoanStatus {
  ACTIVE
  PAUSED
  COMPLETED
  WRITTEN_OFF
}

enum DeductionType {
  UNPAID_LEAVE
  LOAN_REPAYMENT
  ADVANCE_DEDUCTION
  OTHER
}

// ===== Payroll Management Module Models =====

model SalaryStructure {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId   String       @unique
  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Core salary components (all stored in QAR)
  basicSalary            Decimal @db.Decimal(12, 2)
  housingAllowance       Decimal @default(0) @db.Decimal(12, 2)
  transportAllowance     Decimal @default(0) @db.Decimal(12, 2)
  foodAllowance          Decimal @default(0) @db.Decimal(12, 2)
  phoneAllowance         Decimal @default(0) @db.Decimal(12, 2)
  otherAllowances        Decimal @default(0) @db.Decimal(12, 2)
  otherAllowancesDetails String? // JSON: [{ name, amount }]

  // Total calculated monthly salary
  grossSalary Decimal @db.Decimal(12, 2)

  // Currency (for reference, values stored in QAR)
  currency String @default("QAR")

  // Effective dates
  effectiveFrom DateTime
  effectiveTo   DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  history SalaryStructureHistory[]

  @@index([userId])
  @@index([effectiveFrom])
  @@index([isActive])
  @@index([tenantId])
}

model SalaryStructureHistory {
  id                String          @id @default(cuid())
  salaryStructureId String
  salaryStructure   SalaryStructure @relation(fields: [salaryStructureId], references: [id], onDelete: Cascade)

  action         String // CREATED, UPDATED, DEACTIVATED
  changes        Json? // Field changes
  previousValues Json? // Previous salary values
  notes          String?

  performedById String
  performedBy   User   @relation("SalaryHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([salaryStructureId])
  @@index([createdAt])
}

model PayrollRun {
  id              String       @id @default(cuid())
  tenantId        String
  tenant          Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  referenceNumber String // {PREFIX}-PAY-YYYY-MM-XXX (tenant-scoped unique)

  // Period
  year        Int
  month       Int // 1-12
  periodStart DateTime
  periodEnd   DateTime

  // Status workflow
  status PayrollStatus @default(DRAFT)

  // Totals
  totalGross      Decimal @db.Decimal(14, 2)
  totalDeductions Decimal @db.Decimal(14, 2)
  totalNet        Decimal @db.Decimal(14, 2)
  employeeCount   Int     @default(0)

  // WPS
  wpsFileGenerated Boolean   @default(false)
  wpsFileUrl       String?
  wpsGeneratedAt   DateTime?

  // Workflow
  submittedById String?
  submittedBy   User?     @relation("PayrollSubmitter", fields: [submittedById], references: [id])
  submittedAt   DateTime?

  approvedById  String?
  approvedBy    User?     @relation("PayrollApprover", fields: [approvedById], references: [id])
  approvedAt    DateTime?
  approverNotes String?

  processedById String?
  processedBy   User?     @relation("PayrollProcessor", fields: [processedById], references: [id])
  processedAt   DateTime?

  paidById         String?
  paidBy           User?     @relation("PayrollPayer", fields: [paidById], references: [id])
  paidAt           DateTime?
  paymentReference String?

  createdById String
  createdBy   User   @relation("PayrollCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payslips Payslip[]
  history  PayrollHistory[]

  @@unique([tenantId, year, month])
  @@unique([tenantId, referenceNumber])
  @@index([status])
  @@index([year, month])
  @@index([referenceNumber])
  @@index([tenantId])
  @@index([tenantId, status])
}

model PayrollHistory {
  id           String     @id @default(cuid())
  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)

  action         String // CREATED, STATUS_CHANGED, UPDATED, WPS_GENERATED
  previousStatus PayrollStatus?
  newStatus      PayrollStatus?
  changes        Json?
  notes          String?

  performedById String
  performedBy   User   @relation("PayrollHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([payrollRunId])
  @@index([createdAt])
}

model Payslip {
  id            String       @id @default(cuid())
  tenantId      String
  tenant        Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payslipNumber String // {PREFIX}-PS-YYYY-MM-XXXXX (tenant-scoped unique)

  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Salary Components (snapshot from SalaryStructure)
  basicSalary            Decimal @db.Decimal(12, 2)
  housingAllowance       Decimal @db.Decimal(12, 2)
  transportAllowance     Decimal @db.Decimal(12, 2)
  foodAllowance          Decimal @db.Decimal(12, 2)
  phoneAllowance         Decimal @db.Decimal(12, 2)
  otherAllowances        Decimal @db.Decimal(12, 2)
  otherAllowancesDetails String?

  grossSalary Decimal @db.Decimal(12, 2)

  // Deductions
  totalDeductions Decimal @db.Decimal(12, 2)

  // Net
  netSalary Decimal @db.Decimal(12, 2)

  // Payment Info (from HR Profile)
  bankName String?
  iban     String?

  // WPS Info (from HR Profile)
  qidNumber String?

  // Status
  isPaid Boolean   @default(false)
  paidAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deductions PayslipDeduction[]

  @@unique([payrollRunId, userId])
  @@unique([tenantId, payslipNumber])
  @@index([payrollRunId])
  @@index([userId])
  @@index([payslipNumber])
  @@index([tenantId])
  @@index([tenantId, isPaid])
}

model PayslipDeduction {
  id        String  @id @default(cuid())
  payslipId String
  payslip   Payslip @relation(fields: [payslipId], references: [id], onDelete: Cascade)

  type        DeductionType
  description String
  amount      Decimal       @db.Decimal(12, 2)

  // Reference to related entities
  leaveRequestId String? // If UNPAID_LEAVE
  loanId         String? // If LOAN_REPAYMENT
  advanceId      String? // If ADVANCE_DEDUCTION

  createdAt DateTime @default(now())

  @@index([payslipId])
  @@index([type])
}

model EmployeeLoan {
  id         String       @id @default(cuid())
  tenantId   String
  tenant     Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loanNumber String // {PREFIX}-LOAN-XXXXX (tenant-scoped unique)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Loan Details
  type        String // LOAN, ADVANCE
  description String

  // Amounts
  principalAmount  Decimal @db.Decimal(12, 2)
  totalAmount      Decimal @db.Decimal(12, 2) // Including any interest/fees
  monthlyDeduction Decimal @db.Decimal(12, 2)

  // Repayment tracking
  totalPaid       Decimal @default(0) @db.Decimal(12, 2)
  remainingAmount Decimal @db.Decimal(12, 2)

  // Schedule
  startDate        DateTime // When deductions start
  endDate          DateTime? // Expected end date
  installments     Int // Number of monthly installments
  installmentsPaid Int       @default(0)

  status LoanStatus @default(ACTIVE)

  // Approval
  approvedById String?
  approvedBy   User?     @relation("LoanApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  notes String?

  createdById String
  createdBy   User   @relation("LoanCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  repayments LoanRepayment[]

  @@unique([tenantId, loanNumber])
  @@index([userId])
  @@index([status])
  @@index([loanNumber])
  @@index([tenantId])
}

model LoanRepayment {
  id     String       @id @default(cuid())
  loanId String
  loan   EmployeeLoan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  amount    Decimal @db.Decimal(12, 2)
  payslipId String? // Link to payslip if deducted from salary

  // Payment details
  paymentDate   DateTime
  paymentMethod String // SALARY_DEDUCTION, CASH, BANK_TRANSFER
  reference     String?

  notes String?

  recordedById String
  recordedBy   User   @relation("RepaymentRecorder", fields: [recordedById], references: [id])

  createdAt DateTime @default(now())

  @@index([loanId])
  @@index([paymentDate])
}

// ═══════════════════════════════════════════════════════════════════════════════
// ASSET REQUEST WORKFLOW - Employee requests, admin assignments, and returns
// ═══════════════════════════════════════════════════════════════════════════════

model AssetRequest {
  id            String             @id @default(cuid())
  tenantId      String
  tenant        Organization       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requestNumber String // {PREFIX}-AR-YYMMDD-XXX (tenant-scoped unique)
  type          AssetRequestType
  status        AssetRequestStatus

  // Asset being requested/assigned
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Target user (requester for EMPLOYEE_REQUEST, assignee for ADMIN_ASSIGNMENT)
  userId String
  user   User   @relation("AssetRequestUser", fields: [userId], references: [id])

  // Request details
  reason String? // Reason for request/return
  notes  String? // Additional notes

  // For ADMIN_ASSIGNMENT: who initiated the assignment
  assignedById   String?
  assignedByUser User?   @relation("AssetRequestAssigner", fields: [assignedById], references: [id])

  // Processing info (approve/reject/accept/decline)
  processedById   String?
  processedByUser User?     @relation("AssetRequestProcessor", fields: [processedById], references: [id])
  processedAt     DateTime?
  processorNotes  String?

  // Optional expiry for pending requests
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  history AssetRequestHistory[]

  @@unique([tenantId, requestNumber])
  @@index([assetId])
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([tenantId])
}

model AssetRequestHistory {
  id             String       @id @default(cuid())
  assetRequestId String
  assetRequest   AssetRequest @relation(fields: [assetRequestId], references: [id], onDelete: Cascade)

  action    String // CREATED, STATUS_CHANGED, APPROVED, REJECTED, ACCEPTED, DECLINED, CANCELLED
  oldStatus AssetRequestStatus?
  newStatus AssetRequestStatus?
  notes     String?

  performedById String
  performedBy   User   @relation("AssetRequestHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([assetRequestId])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════════════════════
// ASSET DEPRECIATION - Qatar Tax Rates & IFRS Compliance
// ═══════════════════════════════════════════════════════════════════════════════

model DepreciationCategory {
  id              String  @id @default(cuid())
  name            String // "Buildings", "Vehicles", etc.
  code            String  @unique // "BUILDINGS", "VEHICLES", etc.
  annualRate      Decimal @db.Decimal(5, 2) // 4.00, 20.00
  usefulLifeYears Int // 25, 5, etc.
  description     String?
  isActive        Boolean @default(true)

  assets Asset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DepreciationRecord {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assetId  String
  asset    Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)

  periodStart        DateTime
  periodEnd          DateTime
  depreciationAmount Decimal  @db.Decimal(12, 2)
  accumulatedAmount  Decimal  @db.Decimal(12, 2)
  netBookValue       Decimal  @db.Decimal(12, 2)

  calculationType String // "SCHEDULED" | "MANUAL"
  calculatedAt    DateTime @default(now())
  calculatedById  String?
  calculatedBy    User?    @relation("DepreciationRecordCalculator", fields: [calculatedById], references: [id])
  notes           String?

  @@index([tenantId])
  @@index([assetId])
  @@index([periodEnd])
}

// ===== Company Document Management =====

model CompanyDocumentType {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String // e.g., "Commercial Registration", "Trade License"
  code        String // e.g., "CR", "TRADE_LICENSE" (for system use)
  category    String       @default("COMPANY") // COMPANY or VEHICLE
  description String?
  isActive    Boolean      @default(true)
  sortOrder   Int          @default(0)

  // Relations
  documents CompanyDocument[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@index([tenantId])
}

model CompanyDocument {
  id       String       @id @default(cuid())
  tenantId String
  tenant   Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Document Classification (linked to admin-managed types)
  documentTypeId  String
  documentType    CompanyDocumentType @relation(fields: [documentTypeId], references: [id])
  referenceNumber String? // Document number/ID

  // Issuing Authority & Expiry
  issuedBy   String? // e.g., "Ministry of Commerce"
  expiryDate DateTime // Required - indexed for alerts

  // File Storage
  documentUrl String? // Supabase storage URL

  // Vehicle Linking (optional - for VEHICLE category types)
  assetId String?
  asset   Asset?  @relation(fields: [assetId], references: [id])

  // Status & Notes
  renewalCost Decimal? @db.Decimal(12, 2)
  notes       String?

  // Audit
  createdById String
  createdBy   User   @relation("CompanyDocumentCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiryDate])
  @@index([documentTypeId])
  @@index([assetId])
  @@index([tenantId])
  // SECURITY: Compound index for tenant-scoped expiry alerts (prevents full table scan)
  @@index([tenantId, expiryDate])
}

// ═══════════════════════════════════════════════════════════════════════════════
// AI CHATBOT - Conversation History
// ═══════════════════════════════════════════════════════════════════════════════

model ChatConversation {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  title     String? // Auto-generated from first message
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Organization  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
}

model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String // "user" | "assistant"
  content        String   @db.Text
  functionCalls  Json? // Store function call details
  createdAt      DateTime @default(now())

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════════════════════
// AI CHAT USAGE TRACKING
// ═══════════════════════════════════════════════════════════════════════════════

model AIChatUsage {
  id        String  @id @default(cuid())
  tenantId  String
  userId    String
  messageId String? // Optional link to ChatMessage

  // Token counts from OpenAI response
  promptTokens     Int
  completionTokens Int
  totalTokens      Int

  // Model used
  model String @default("gpt-4o-mini")

  // Calculated cost in USD (based on model pricing)
  costUsd Float

  createdAt DateTime @default(now())

  tenant Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@index([userId])
}

// AI Chat Audit Log - For security monitoring and compliance
model AIChatAuditLog {
  id             String  @id @default(cuid())
  tenantId       String
  userId         String
  conversationId String?

  // Privacy-friendly query tracking
  queryHash   String // SHA-256 hash of the query (for pattern detection without storing content)
  queryLength Int // Character count of original query

  // What was accessed
  functionsCalled Json // Array of function names called
  dataAccessed    Json // Summary of data types accessed

  // Performance & usage
  tokensUsed     Int
  responseTimeMs Int

  // Security metadata
  ipAddress String?
  userAgent String?

  // Risk assessment
  flagged     Boolean  @default(false)
  flagReasons String[] @default([])
  riskScore   Int      @default(0)

  createdAt DateTime @default(now())

  tenant Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@index([flagged])
}

// ═══════════════════════════════════════════════════════════════════════════════
// WHATSAPP BUSINESS API INTEGRATION
// ═══════════════════════════════════════════════════════════════════════════════

// Per-tenant WhatsApp Business API credentials
model WhatsAppConfig {
  id                   String       @id @default(cuid())
  tenantId             String       @unique
  tenant               Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  phoneNumberId        String // Meta Phone Number ID
  businessAccountId    String // WhatsApp Business Account ID
  accessTokenEncrypted String // Encrypted permanent access token
  webhookVerifyToken   String // For webhook verification
  isActive             Boolean      @default(true)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@index([tenantId])
}

// Map users to their WhatsApp phone numbers
model WhatsAppUserPhone {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId      String       @unique
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  phoneNumber String // E.164 format: +974XXXXXXXX
  isVerified  Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([tenantId])
  @@index([phoneNumber])
}

// One-time action tokens for button callbacks
model WhatsAppActionToken {
  id         String       @id @default(cuid())
  tenantId   String
  tenant     Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  token      String       @unique // Encrypted token
  entityType String // 'LEAVE_REQUEST', 'PURCHASE_REQUEST', 'ASSET_REQUEST'
  entityId   String
  action     String // 'approve', 'reject'
  approverId String // User who should perform action
  used       Boolean      @default(false)
  usedAt     DateTime?
  expiresAt  DateTime // 60-minute expiry
  createdAt  DateTime     @default(now())

  @@index([tenantId])
  @@index([token])
  @@index([expiresAt])
}

// Message logging for debugging/audit
model WhatsAppMessageLog {
  id             String       @id @default(cuid())
  tenantId       String
  tenant         Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messageId      String? // Meta message ID
  recipientPhone String
  templateName   String
  status         String // 'sent', 'delivered', 'read', 'failed'
  errorMessage   String?
  entityType     String?
  entityId       String?
  configSource   String? // 'PLATFORM' or 'CUSTOM' - which config was used
  createdAt      DateTime     @default(now())

  @@index([tenantId])
  @@index([messageId])
}

// Platform-wide WhatsApp configuration (Super Admin only)
model PlatformWhatsAppConfig {
  id                   String   @id @default(cuid())
  phoneNumberId        String // Meta Phone Number ID
  businessAccountId    String // WhatsApp Business Account ID
  accessTokenEncrypted String // Encrypted permanent access token
  webhookVerifyToken   String // For webhook verification
  displayPhoneNumber   String? // Human-readable phone number for display
  businessName         String? // Business name for branding
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}
